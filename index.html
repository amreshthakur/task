<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School ERP - Offline Management System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
    <style>
        /* ===== CSS Variables ===== */
        :root {
            --primary-color: #4a6fa5;
            --primary-dark: #385d8a;
            --primary-light: #6b8cbc;
            --secondary-color: #66bb6a;
            --danger-color: #f44336;
            --warning-color: #ff9800;
            --info-color: #2196f3;
            --success-color: #4caf50;
            
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-light: #888888;
            
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --bg-sidebar: #2c3e50;
            --bg-header: #ffffff;
            
            --border-color: #e0e0e0;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 5px 20px rgba(0, 0, 0, 0.15);
            
            --sidebar-width: 250px;
            --sidebar-collapsed-width: 70px;
            --header-height: 70px;
            
            --border-radius: 8px;
            --border-radius-sm: 4px;
            
            --transition: all 0.3s ease;
        }

        /* Dark mode variables */
        .dark-mode {
            --primary-color: #5d8cc7;
            --primary-dark: #4a6fa5;
            --primary-light: #7a9fd6;
            
            --text-primary: #f0f0f0;
            --text-secondary: #cccccc;
            --text-light: #aaaaaa;
            
            --bg-primary: #121212;
            --bg-secondary: #1e1e1e;
            --bg-sidebar: #1a252f;
            --bg-header: #1e1e1e;
            
            --border-color: #333333;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 5px 20px rgba(0, 0, 0, 0.4);
        }

        /* ===== Base Styles ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: var(--transition);
            overflow-x: hidden;
        }

        /* ===== Lock Screen ===== */
        .lock-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
        }

        .lock-container {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 3rem;
            border-radius: var(--border-radius);
            max-width: 400px;
            width: 90%;
            box-shadow: var(--shadow-lg);
        }

        .lock-icon {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            color: white;
        }

        .lock-container h2 {
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .lock-container p {
            margin-bottom: 1.5rem;
            opacity: 0.9;
        }

        .pin-input input {
            width: 100%;
            padding: 1rem;
            font-size: 1.5rem;
            text-align: center;
            border: none;
            border-radius: var(--border-radius);
            background: rgba(255, 255, 255, 0.9);
            margin-bottom: 1.5rem;
            letter-spacing: 0.5rem;
        }

        .pin-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .note {
            font-size: 0.8rem;
            margin-top: 1.5rem;
            opacity: 0.8;
        }

        /* ===== Main App Container ===== */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* ===== Header ===== */
        .app-header {
            height: var(--header-height);
            background-color: var(--bg-header);
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 1.5rem;
            position: sticky;
            top: 0;
            z-index: 100;
            transition: var(--transition);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .sidebar-toggle {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-primary);
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .sidebar-toggle:hover {
            background-color: var(--bg-primary);
        }

        .school-info h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .school-info p {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .datetime {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
        }

        .icon-btn {
            background: none;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-primary);
            font-size: 1.2rem;
            transition: var(--transition);
        }

        .icon-btn:hover {
            background-color: var(--bg-primary);
            color: var(--primary-color);
        }

        /* ===== Sidebar ===== */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-sidebar);
            color: white;
            display: flex;
            flex-direction: column;
            position: fixed;
            top: var(--header-height);
            left: 0;
            height: calc(100vh - var(--header-height));
            transition: var(--transition);
            z-index: 99;
            box-shadow: var(--shadow);
        }

        .sidebar.collapsed {
            width: var(--sidebar-collapsed-width);
        }

        .sidebar-nav {
            flex: 1;
            padding: 1.5rem 0;
            overflow-y: auto;
        }

        .sidebar-nav ul {
            list-style: none;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: var(--transition);
            border-left: 3px solid transparent;
        }

        .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            border-left-color: var(--primary-light);
        }

        .nav-link.active {
            background-color: rgba(255, 255, 255, 0.15);
            color: white;
            border-left-color: var(--primary-color);
        }

        .nav-link i {
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
        }

        .sidebar.collapsed .nav-link span {
            display: none;
        }

        .sidebar-footer {
            padding: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.8rem;
        }

        .storage-info {
            margin-bottom: 1rem;
        }

        .storage-bar {
            height: 6px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .storage-fill {
            height: 100%;
            background-color: var(--primary-color);
            width: 30%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .offline-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: rgba(255, 255, 255, 0.7);
        }

        /* ===== Main Content ===== */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 1.5rem;
            overflow-y: auto;
            transition: var(--transition);
            background-color: var(--bg-primary);
        }

        .sidebar.collapsed + .main-content {
            margin-left: var(--sidebar-collapsed-width);
        }

        /* ===== Page Styles ===== */
        .page {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .page-title {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .page-actions {
            display: flex;
            gap: 1rem;
        }

        /* ===== Buttons ===== */
        .btn {
            padding: 0.7rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.95rem;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn-secondary {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background-color: var(--bg-primary);
            border-color: var(--primary-color);
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #3d8b40;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #d32f2f;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background-color: #f57c00;
        }

        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
        }

        /* ===== Cards ===== */
        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .card {
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            transition: var(--transition);
            border: 1px solid var(--border-color);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .card-icon.students { background-color: #4a6fa5; }
        .card-icon.teachers { background-color: #66bb6a; }
        .card-icon.classes { background-color: #ff9800; }
        .card-icon.attendance { background-color: #2196f3; }
        .card-icon.fees { background-color: #9c27b0; }
        .card-icon.notices { background-color: #f44336; }

        .card-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .card-change {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .card-change.positive { color: var(--success-color); }
        .card-change.negative { color: var(--danger-color); }

        /* ===== Tables ===== */
        .table-container {
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 1rem;
        }

        .table-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .table-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            padding: 0.7rem 1rem 0.7rem 2.5rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            font-family: 'Poppins', sans-serif;
            width: 250px;
            transition: var(--transition);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(74, 111, 165, 0.2);
        }

        .search-box i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
        }

        .table-responsive {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        thead {
            background-color: var(--bg-primary);
            border-bottom: 2px solid var(--border-color);
        }

        th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        tbody tr {
            transition: var(--transition);
        }

        tbody tr:hover {
            background-color: var(--bg-primary);
        }

        /* ===== Badges ===== */
        .badge {
            display: inline-block;
            padding: 0.3rem 0.7rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .badge-success {
            background-color: rgba(76, 175, 80, 0.15);
            color: var(--success-color);
        }

        .badge-danger {
            background-color: rgba(244, 67, 54, 0.15);
            color: var(--danger-color);
        }

        .badge-warning {
            background-color: rgba(255, 152, 0, 0.15);
            color: var(--warning-color);
        }

        .badge-info {
            background-color: rgba(33, 150, 243, 0.15);
            color: var(--info-color);
        }

        .badge-primary {
            background-color: rgba(74, 111, 165, 0.15);
            color: var(--primary-color);
        }

        /* ===== Modals ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal {
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .modal-close:hover {
            background-color: var(--bg-primary);
            color: var(--danger-color);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        /* ===== Forms ===== */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-control {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            font-family: 'Poppins', sans-serif;
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(74, 111, 165, 0.2);
        }

        .form-row {
            display: flex;
            gap: 1rem;
        }

        .form-row .form-group {
            flex: 1;
        }

        /* ===== Toast Notifications ===== */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1001;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 350px;
        }

        .toast {
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 1rem 1.5rem;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 1rem;
            animation: slideInRight 0.3s ease;
            border-left: 4px solid var(--primary-color);
        }

        .toast.success {
            border-left-color: var(--success-color);
        }

        .toast.error {
            border-left-color: var(--danger-color);
        }

        .toast.warning {
            border-left-color: var(--warning-color);
        }

        .toast.info {
            border-left-color: var(--info-color);
        }

        .toast-icon {
            font-size: 1.5rem;
        }

        .toast.success .toast-icon { color: var(--success-color); }
        .toast.error .toast-icon { color: var(--danger-color); }
        .toast.warning .toast-icon { color: var(--warning-color); }
        .toast.info .toast-icon { color: var(--info-color); }

        .toast-message {
            flex: 1;
            font-weight: 500;
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.2rem;
        }

        /* ===== Profile Page ===== */
        .profile-header {
            display: flex;
            align-items: center;
            gap: 2rem;
            padding: 2rem;
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
        }

        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background-color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: white;
            font-weight: 700;
        }

        .profile-info h2 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .profile-info p {
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .profile-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 2rem;
        }

        .tab-btn {
            padding: 1rem 2rem;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
        }

        .tab-btn:hover {
            color: var(--primary-color);
        }

        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        /* ===== Attendance Grid ===== */
        .attendance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .attendance-card {
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            box-shadow: var(--shadow);
            transition: var(--transition);
            cursor: pointer;
            border: 2px solid transparent;
        }

        .attendance-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        .attendance-card.present {
            border-color: var(--success-color);
        }

        .attendance-card.absent {
            border-color: var(--danger-color);
        }

        .attendance-card.selected.present {
            background-color: rgba(76, 175, 80, 0.1);
        }

        .attendance-card.selected.absent {
            background-color: rgba(244, 67, 54, 0.1);
        }

        .attendance-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--primary-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
            margin-bottom: 0.5rem;
        }

        .attendance-name {
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .attendance-status {
            font-size: 0.8rem;
            padding: 0.2rem 0.5rem;
            border-radius: 20px;
        }

        /* ===== Timetable ===== */
        .timetable {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .timetable th {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            text-align: center;
        }

        .timetable td {
            padding: 1rem;
            border: 1px solid var(--border-color);
            text-align: center;
            vertical-align: top;
        }

        .timetable-period {
            font-weight: 600;
            color: var(--primary-color);
        }

        .timetable-subject {
            font-weight: 500;
            margin-bottom: 0.3rem;
            color: var(--text-primary);
        }

        .timetable-teacher {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* ===== Notice Board ===== */
        .notices-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .notice-card {
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--primary-color);
            transition: var(--transition);
        }

        .notice-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        .notice-card.important {
            border-left-color: var(--danger-color);
        }

        .notice-card.warning {
            border-left-color: var(--warning-color);
        }

        .notice-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .notice-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .notice-date {
            font-size: 0.9rem;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .notice-content {
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* ===== Settings Page ===== */
        .settings-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
        }

        .settings-nav {
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            height: fit-content;
        }

        .settings-nav ul {
            list-style: none;
        }

        .settings-nav li {
            margin-bottom: 0.5rem;
        }

        .settings-nav a {
            display: block;
            padding: 0.8rem 1rem;
            color: var(--text-primary);
            text-decoration: none;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .settings-nav a:hover {
            background-color: var(--bg-primary);
        }

        .settings-nav a.active {
            background-color: var(--primary-color);
            color: white;
        }

        .settings-content {
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--shadow);
        }

        .settings-section {
            display: none;
        }

        .settings-section.active {
            display: block;
        }

        /* ===== Pagination ===== */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            padding: 1.5rem;
            border-top: 1px solid var(--border-color);
        }

        .pagination-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition);
        }

        .pagination-btn:hover:not(:disabled) {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-pages {
            display: flex;
            gap: 0.3rem;
        }

        .page-btn {
            width: 40px;
            height: 40px;
            border-radius: var(--border-radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition);
        }

        .page-btn:hover {
            background-color: var(--bg-primary);
        }

        .page-btn.active {
            background-color: var(--primary-color);
            color: white;
        }

        /* ===== Fee Structure ===== */
        .fee-structure-table {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .fee-structure-table th {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            text-align: left;
        }

        .fee-structure-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .fee-amount {
            font-weight: 600;
            color: var(--primary-color);
        }

        /* ===== Exam Results ===== */
        .exam-results-table {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .exam-results-table th {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            text-align: left;
        }

        .exam-results-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .result-grade {
            font-weight: 600;
            padding: 0.3rem 0.7rem;
            border-radius: 20px;
        }

        .grade-a { background-color: rgba(76, 175, 80, 0.15); color: var(--success-color); }
        .grade-b { background-color: rgba(33, 150, 243, 0.15); color: var(--info-color); }
        .grade-c { background-color: rgba(255, 152, 0, 0.15); color: var(--warning-color); }
        .grade-d { background-color: rgba(244, 67, 54, 0.15); color: var(--danger-color); }
        .grade-f { background-color: rgba(158, 158, 158, 0.15); color: var(--text-secondary); }

        /* ===== Responsive ===== */
        @media (max-width: 992px) {
            .settings-container {
                grid-template-columns: 1fr;
            }
            
            .cards-container {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                width: var(--sidebar-width);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0 !important;
            }
            
            .header-right {
                gap: 1rem;
            }
            
            .school-info h1 {
                font-size: 1.2rem;
            }
            
            .search-box input {
                width: 200px;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .attendance-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
            
            .modal {
                margin: 1rem;
                width: calc(100% - 2rem) !important;
            }
        }

        @media (max-width: 576px) {
            .app-header {
                padding: 0 1rem;
            }
            
            .header-right {
                flex-direction: column;
                align-items: flex-end;
                gap: 0.5rem;
            }
            
            .page-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .table-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .table-controls {
                width: 100%;
            }
            
            .search-box input {
                width: 100%;
            }
            
            .profile-header {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }
            
            .cards-container {
                grid-template-columns: 1fr;
            }
            
            .attendance-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
            
            .form-control, .btn {
                font-size: 16px !important;
            }
        }
        
        /* Additional fixes */
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        
        .form-control:invalid {
            border-color: var(--danger-color);
        }
        
        .form-control:valid {
            border-color: var(--success-color);
        }
    </style>
</head>
<body>
    <!-- PIN Lock Screen -->
    <div id="lockScreen" class="lock-screen">
        <div class="lock-container">
            <div class="lock-icon">
                <i class="fas fa-lock"></i>
            </div>
            <h2>School ERP - Secure Access</h2>
            <p>Enter PIN to access the system</p>
            <div class="pin-input">
                <input type="password" id="pinField" maxlength="4" placeholder="Enter 4-digit PIN" autofocus>
            </div>
            <div class="pin-buttons">
                <button class="btn btn-primary" id="unlockBtn">Unlock</button>
                <button class="btn btn-secondary" id="resetPinBtn">Reset PIN</button>
            </div>
            <p class="note">Default PIN: 1234 (You can change it in Settings)</p>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="appContainer" class="app-container" style="display: none;">
        <!-- Header -->
        <header class="app-header">
            <div class="header-left">
                <button class="sidebar-toggle" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="school-info">
                    <h1 id="schoolName">Greenwood High School</h1>
                    <p id="academicYear">Academic Year: 2023-2024</p>
                </div>
            </div>
            <div class="header-right">
                <div class="datetime" id="currentDateTime">
                    <!-- Will be updated by JS -->
                </div>
                <div class="header-actions">
                    <button class="icon-btn" id="themeToggle" title="Toggle Dark Mode">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button class="icon-btn" id="exportBtn" title="Export Data">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="icon-btn" id="importBtn" title="Import Data">
                        <i class="fas fa-upload"></i>
                    </button>
                    <button class="icon-btn" id="settingsBtn" title="Settings">
                        <i class="fas fa-cog"></i>
                    </button>
                    <button class="icon-btn" id="lockBtn" title="Lock System">
                        <i class="fas fa-lock"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <nav class="sidebar-nav">
                <ul>
                    <li>
                        <a href="#dashboard" class="nav-link active" data-page="dashboard">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li>
                        <a href="#students" class="nav-link" data-page="students">
                            <i class="fas fa-user-graduate"></i>
                            <span>Students</span>
                        </a>
                    </li>
                    <li>
                        <a href="#teachers" class="nav-link" data-page="teachers">
                            <i class="fas fa-chalkboard-teacher"></i>
                            <span>Teachers</span>
                        </a>
                    </li>
                    <li>
                        <a href="#classes" class="nav-link" data-page="classes">
                            <i class="fas fa-school"></i>
                            <span>Classes</span>
                        </a>
                    </li>
                    <li>
                        <a href="#attendance" class="nav-link" data-page="attendance">
                            <i class="fas fa-clipboard-check"></i>
                            <span>Attendance</span>
                        </a>
                    </li>
                    <li>
                        <a href="#exams" class="nav-link" data-page="exams">
                            <i class="fas fa-file-alt"></i>
                            <span>Exams & Results</span>
                        </a>
                    </li>
                    <li>
                        <a href="#fees" class="nav-link" data-page="fees">
                            <i class="fas fa-money-check-alt"></i>
                            <span>Fee Management</span>
                        </a>
                    </li>
                    <li>
                        <a href="#timetable" class="nav-link" data-page="timetable">
                            <i class="fas fa-calendar-alt"></i>
                            <span>Timetable</span>
                        </a>
                    </li>
                    <li>
                        <a href="#notices" class="nav-link" data-page="notices">
                            <i class="fas fa-bullhorn"></i>
                            <span>Notice Board</span>
                        </a>
                    </li>
                    <li>
                        <a href="#settings" class="nav-link" data-page="settings">
                            <i class="fas fa-cogs"></i>
                            <span>Settings</span>
                        </a>
                    </li>
                </ul>
            </nav>
            <div class="sidebar-footer">
                <div class="storage-info">
                    <div class="storage-bar">
                        <div class="storage-fill" id="storageFill"></div>
                    </div>
                    <small>Local Storage: <span id="storageUsed">0</span> KB used</small>
                </div>
                <div class="offline-status">
                    <i class="fas fa-wifi-slash"></i>
                    <span>Offline Mode</span>
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="main-content" id="mainContent">
            <!-- Pages will be dynamically loaded here -->
            <div class="page active" id="dashboardPage"></div>
            <div class="page" id="studentsPage"></div>
            <div class="page" id="teachersPage"></div>
            <div class="page" id="classesPage"></div>
            <div class="page" id="attendancePage"></div>
            <div class="page" id="examsPage"></div>
            <div class="page" id="feesPage"></div>
            <div class="page" id="timetablePage"></div>
            <div class="page" id="noticesPage"></div>
            <div class="page" id="settingsPage"></div>
        </main>

        <!-- Modals will be appended here dynamically -->
        <div id="modalContainer"></div>

        <!-- Toast notifications -->
        <div id="toastContainer" class="toast-container"></div>
    </div>

    <script>
        // ============================================
        // FIXED Storage Management System
        // ============================================
        class SchoolERPStorage {
            constructor() {
                this.initStorage();
            }
            
            initStorage() {
                // Initialize all storage keys with default values if they don't exist
                const defaults = {
                    settings: {
                        schoolName: "Greenwood High School",
                        academicYear: "2023-2024",
                        theme: "light",
                        pin: "1234",
                        autoLock: true
                    },
                    students: [],
                    teachers: [],
                    classes: [],
                    subjects: [],
                    attendance: [],
                    exams: [],
                    results: [],
                    fees: [],
                    feeStructure: [],
                    timetable: [],
                    notices: []
                };
                
                for (const [key, value] of Object.entries(defaults)) {
                    if (!this.get(key)) {
                        this.set(key, value);
                    }
                }
                
                // Initialize sample data
                this.initSampleData();
                
                // Update storage usage display
                this.updateStorageUsage();
            }
            
            get(key) {
                try {
                    const item = localStorage.getItem(`schoolERP_${key}`);
                    return item ? JSON.parse(item) : null;
                } catch (error) {
                    console.error(`Error getting ${key} from storage:`, error);
                    return null;
                }
            }
            
            set(key, value) {
                try {
                    localStorage.setItem(`schoolERP_${key}`, JSON.stringify(value));
                    this.updateStorageUsage();
                    return true;
                } catch (error) {
                    console.error(`Error setting ${key} in storage:`, error);
                    this.showStorageError();
                    return false;
                }
            }
            
            updateStorageUsage() {
                let totalBytes = 0;
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('schoolERP_')) {
                        const value = localStorage.getItem(key);
                        totalBytes += value ? value.length * 2 : 0;
                    }
                }
                
                const usedKB = Math.round(totalBytes / 1024);
                const maxKB = 5120;
                const percentage = Math.min((usedKB / maxKB) * 100, 100);
                
                const fillElement = document.getElementById('storageFill');
                const usedElement = document.getElementById('storageUsed');
                
                if (fillElement) {
                    fillElement.style.width = `${percentage}%`;
                }
                
                if (usedElement) {
                    usedElement.textContent = usedKB;
                }
                
                if (fillElement) {
                    if (percentage > 90) {
                        fillElement.style.backgroundColor = 'var(--danger-color)';
                    } else if (percentage > 70) {
                        fillElement.style.backgroundColor = 'var(--warning-color)';
                    } else {
                        fillElement.style.backgroundColor = 'var(--primary-color)';
                    }
                }
            }
            
            showStorageError() {
                if (window.showToast) {
                    window.showToast({
                        type: 'error',
                        message: 'Storage is full! Please export your data and clear browser data.',
                        duration: 5000
                    });
                }
            }
            
            exportData() {
                const data = {};
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('schoolERP_')) {
                        const cleanKey = key.replace('schoolERP_', '');
                        try {
                            data[cleanKey] = JSON.parse(localStorage.getItem(key));
                        } catch (e) {
                            console.error(`Error parsing ${key}:`, e);
                        }
                    }
                }
                
                data.exportDate = new Date().toISOString();
                data.appVersion = "1.0.0";
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `school-erp-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                return true;
            }
            
            importData(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const data = JSON.parse(event.target.result);
                            
                            if (!data.settings || !data.students) {
                                throw new Error('Invalid backup file format');
                            }
                            
                            // Clear existing data
                            for (let i = 0; i < localStorage.length; i++) {
                                const key = localStorage.key(i);
                                if (key.startsWith('schoolERP_')) {
                                    localStorage.removeItem(key);
                                }
                            }
                            
                            // Import new data
                            for (const [key, value] of Object.entries(data)) {
                                this.set(key, value);
                            }
                            
                            resolve(true);
                        } catch (error) {
                            reject(error);
                        }
                    };
                    reader.onerror = () => reject(new Error('Failed to read file'));
                    reader.readAsText(file);
                });
            }
            
            generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }
            
            // Student methods
            getStudents() {
                return this.get('students') || [];
            }
            
            saveStudent(student) {
                const students = this.getStudents();
                if (student.id) {
                    const index = students.findIndex(s => s.id === student.id);
                    if (index !== -1) {
                        students[index] = student;
                    }
                } else {
                    student.id = this.generateId();
                    student.admissionNo = student.admissionNo || `STU${String(students.length + 1).padStart(4, '0')}`;
                    student.createdAt = new Date().toISOString();
                    students.push(student);
                }
                
                return this.set('students', students);
            }
            
            deleteStudent(id) {
                const students = this.getStudents();
                const filtered = students.filter(s => s.id !== id);
                return this.set('students', filtered);
            }
            
            // Teacher methods
            getTeachers() {
                return this.get('teachers') || [];
            }
            
            saveTeacher(teacher) {
                const teachers = this.getTeachers();
                if (teacher.id) {
                    const index = teachers.findIndex(t => t.id === teacher.id);
                    if (index !== -1) {
                        teachers[index] = teacher;
                    }
                } else {
                    teacher.id = this.generateId();
                    teacher.employeeId = teacher.employeeId || `TCH${String(teachers.length + 1).padStart(4, '0')}`;
                    teacher.createdAt = new Date().toISOString();
                    teachers.push(teacher);
                }
                
                return this.set('teachers', teachers);
            }
            
            deleteTeacher(id) {
                const teachers = this.getTeachers();
                const filtered = teachers.filter(t => t.id !== id);
                return this.set('teachers', filtered);
            }
            
            // Class methods
            getClasses() {
                return this.get('classes') || [];
            }
            
            saveClass(cls) {
                const classes = this.getClasses();
                if (cls.id) {
                    const index = classes.findIndex(c => c.id === cls.id);
                    if (index !== -1) {
                        classes[index] = cls;
                    }
                } else {
                    cls.id = this.generateId();
                    cls.createdAt = new Date().toISOString();
                    classes.push(cls);
                }
                
                return this.set('classes', classes);
            }
            
            deleteClass(id) {
                const classes = this.getClasses();
                const filtered = classes.filter(c => c.id !== id);
                return this.set('classes', filtered);
            }
            
            // Subject methods
            getSubjects() {
                return this.get('subjects') || [];
            }
            
            saveSubject(subject) {
                const subjects = this.getSubjects();
                if (subject.id) {
                    const index = subjects.findIndex(s => s.id === subject.id);
                    if (index !== -1) {
                        subjects[index] = subject;
                    }
                } else {
                    subject.id = this.generateId();
                    subject.createdAt = new Date().toISOString();
                    subjects.push(subject);
                }
                
                return this.set('subjects', subjects);
            }
            
            deleteSubject(id) {
                const subjects = this.getSubjects();
                const filtered = subjects.filter(s => s.id !== id);
                return this.set('subjects', filtered);
            }
            
            // Attendance methods
            getAttendance() {
                return this.get('attendance') || [];
            }
            
            getAttendanceForClass(date, className, section) {
                const allAttendance = this.getAttendance();
                return allAttendance.find(a => 
                    a.date === date && 
                    a.class == className && 
                    a.section === section
                );
            }
            
            saveAttendance(attendance) {
                const allAttendance = this.getAttendance();
                attendance.id = attendance.id || this.generateId();
                attendance.date = attendance.date || new Date().toISOString().split('T')[0];
                attendance.createdAt = new Date().toISOString();
                
                if (attendance.students) {
                    attendance.students = attendance.students.map(student => ({
                        studentId: student.studentId || student.id,
                        id: student.studentId || student.id,
                        name: student.name || '',
                        rollNo: student.rollNo || '',
                        status: student.status || 'absent'
                    }));
                }
                
                const filtered = allAttendance.filter(a => 
                    !(a.date === attendance.date && 
                      a.class == attendance.class && 
                      a.section === attendance.section)
                );
                
                filtered.push(attendance);
                return this.set('attendance', filtered);
            }
            
            // Exam methods
            getExams() {
                return this.get('exams') || [];
            }
            
            saveExam(exam) {
                const exams = this.getExams();
                if (exam.id) {
                    const index = exams.findIndex(e => e.id === exam.id);
                    if (index !== -1) {
                        exams[index] = exam;
                    }
                } else {
                    exam.id = this.generateId();
                    exam.createdAt = new Date().toISOString();
                    exams.push(exam);
                }
                
                return this.set('exams', exams);
            }
            
            deleteExam(id) {
                const exams = this.getExams();
                const filtered = exams.filter(e => e.id !== id);
                return this.set('exams', filtered);
            }
            
            // Result methods
            getResults() {
                return this.get('results') || [];
            }
            
            saveResult(result) {
                const results = this.getResults();
                if (result.id) {
                    const index = results.findIndex(r => r.id === result.id);
                    if (index !== -1) {
                        results[index] = result;
                    }
                } else {
                    result.id = this.generateId();
                    result.createdAt = new Date().toISOString();
                    result.marksObtained = parseFloat(result.marksObtained) || 0;
                    result.maxMarks = parseFloat(result.maxMarks) || 100;
                    results.push(result);
                }
                
                return this.set('results', results);
            }
            
            // Fee methods
            getFees() {
                return this.get('fees') || [];
            }
            
            saveFee(fee) {
                const fees = this.getFees();
                if (fee.id) {
                    const index = fees.findIndex(f => f.id === fee.id);
                    if (index !== -1) {
                        fees[index] = fee;
                    }
                } else {
                    fee.id = this.generateId();
                    fee.createdAt = new Date().toISOString();
                    fee.amount = parseFloat(fee.amount) || 0;
                    fees.push(fee);
                }
                
                return this.set('fees', fees);
            }
            
            deleteFee(id) {
                const fees = this.getFees();
                const filtered = fees.filter(f => f.id !== id);
                return this.set('fees', filtered);
            }
            
            // Fee structure methods
            getFeeStructure() {
                return this.get('feeStructure') || [];
            }
            
            saveFeeStructure(feeStructure) {
                const structures = this.getFeeStructure();
                if (feeStructure.id) {
                    const index = structures.findIndex(f => f.id === feeStructure.id);
                    if (index !== -1) {
                        structures[index] = feeStructure;
                    }
                } else {
                    feeStructure.id = this.generateId();
                    feeStructure.createdAt = new Date().toISOString();
                    structures.push(feeStructure);
                }
                
                return this.set('feeStructure', structures);
            }
            
            deleteFeeStructure(id) {
                const structures = this.getFeeStructure();
                const filtered = structures.filter(f => f.id !== id);
                return this.set('feeStructure', filtered);
            }
            
            // Timetable methods
            getTimetable() {
                return this.get('timetable') || [];
            }
            
            saveTimetable(timetable) {
                const timetables = this.getTimetable();
                if (timetable.id) {
                    const index = timetables.findIndex(t => t.id === timetable.id);
                    if (index !== -1) {
                        timetables[index] = timetable;
                    }
                } else {
                    timetable.id = this.generateId();
                    timetable.createdAt = new Date().toISOString();
                    timetables.push(timetable);
                }
                
                return this.set('timetable', timetables);
            }
            
            deleteTimetable(id) {
                const timetables = this.getTimetable();
                const filtered = timetables.filter(t => t.id !== id);
                return this.set('timetable', filtered);
            }
            
            // Notice methods
            getNotices() {
                return this.get('notices') || [];
            }
            
            saveNotice(notice) {
                const notices = this.getNotices();
                if (notice.id) {
                    const index = notices.findIndex(n => n.id === notice.id);
                    if (index !== -1) {
                        notices[index] = notice;
                    }
                } else {
                    notice.id = this.generateId();
                    notice.date = new Date().toISOString();
                    notice.createdAt = new Date().toISOString();
                    notices.unshift(notice);
                }
                
                return this.set('notices', notices);
            }
            
            deleteNotice(id) {
                const notices = this.getNotices();
                const filtered = notices.filter(n => n.id !== id);
                return this.set('notices', filtered);
            }
            
            // Initialize sample data
            initSampleData() {
                const students = this.getStudents();
                const teachers = this.getTeachers();
                const classes = this.getClasses();
                const subjects = this.getSubjects();
                const feeStructure = this.getFeeStructure();
                const exams = this.getExams();
                const timetable = this.getTimetable();
                
                // Add sample students if empty
                if (students.length === 0) {
                    const sampleStudents = [
                        {
                            id: 'stu1',
                            admissionNo: 'STU001',
                            name: 'John Smith',
                            class: '10',
                            section: 'A',
                            rollNo: '1',
                            gender: 'Male',
                            dob: '2007-05-15',
                            parentName: 'Michael Smith',
                            phone: '555-0101',
                            address: '123 Main Street, City',
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 'stu2',
                            admissionNo: 'STU002',
                            name: 'Emma Johnson',
                            class: '10',
                            section: 'A',
                            rollNo: '2',
                            gender: 'Female',
                            dob: '2007-08-22',
                            parentName: 'Sarah Johnson',
                            phone: '555-0102',
                            address: '456 Oak Avenue, City',
                            createdAt: new Date().toISOString()
                        }
                    ];
                    
                    sampleStudents.forEach(student => this.saveStudent(student));
                }
                
                // Add sample teachers if empty
                if (teachers.length === 0) {
                    const sampleTeachers = [
                        {
                            id: 'tch1',
                            employeeId: 'TCH001',
                            name: 'Dr. Robert Miller',
                            email: 'robert.miller@school.edu',
                            phone: '555-0201',
                            subject: 'Mathematics',
                            classes: ['10', '11', '12'],
                            qualification: 'PhD in Mathematics',
                            experience: '15 years',
                            joinedDate: '2010-06-01'
                        }
                    ];
                    
                    sampleTeachers.forEach(teacher => this.saveTeacher(teacher));
                }
                
                // Add sample classes if empty
                if (classes.length === 0) {
                    const sampleClasses = [
                        { id: 'cls1', name: 'Class 10', sections: ['A', 'B', 'C'], subjects: ['Math', 'Science', 'English'] }
                    ];
                    
                    sampleClasses.forEach(cls => this.saveClass(cls));
                }
                
                // Add sample subjects if empty
                if (subjects.length === 0) {
                    const sampleSubjects = [
                        { id: 'sub1', name: 'Mathematics', code: 'MATH101', teacher: 'Dr. Robert Miller' }
                    ];
                    
                    sampleSubjects.forEach(subject => this.saveSubject(subject));
                }
                
                // Add sample fee structure if empty
                if (feeStructure.length === 0) {
                    const sampleFeeStructure = [
                        { id: 'fee1', class: '10', term: 'Annual', amount: 50000, description: 'Annual Fee' }
                    ];
                    
                    sampleFeeStructure.forEach(fee => this.saveFeeStructure(fee));
                }
                
                // Add sample exams if empty
                if (exams.length === 0) {
                    const sampleExams = [
                        { id: 'exam1', name: 'Unit Test 1', class: '10', subject: 'Mathematics', date: '2024-04-15', maxMarks: 100 }
                    ];
                    
                    sampleExams.forEach(exam => this.saveExam(exam));
                }
                
                // Add sample timetable if empty
                if (timetable.length === 0) {
                    const sampleTimetable = [
                        { 
                            id: 'tt1', 
                            class: '10', 
                            section: 'A',
                            periods: [
                                { day: 'Monday', period1: 'Math', period2: 'Science', period3: 'English', period4: 'PE', period5: 'History' }
                            ]
                        }
                    ];
                    
                    sampleTimetable.forEach(tt => this.saveTimetable(tt));
                }
            }
            
            // Get statistics for dashboard
            getDashboardStats() {
                const students = this.getStudents();
                const teachers = this.getTeachers();
                const classes = this.getClasses();
                const attendance = this.getAttendance();
                const fees = this.getFees();
                const notices = this.getNotices();
                
                const today = new Date().toISOString().split('T')[0];
                const todayAttendance = attendance.filter(a => a.date === today);
                const pendingFees = fees.filter(f => f.status === 'pending').length;
                
                return {
                    totalStudents: students.length,
                    totalTeachers: teachers.length,
                    totalClasses: classes.length,
                    todayAttendance: todayAttendance.length,
                    pendingFees: pendingFees,
                    activeNotices: notices.length
                };
            }
        }

        // Create global storage instance
        window.storage = new SchoolERPStorage();

        // ============================================
        // FIXED UI Management System
        // ============================================
        class SchoolERPUI {
            constructor() {
                this.currentPage = 'dashboard';
                this.currentAttendance = {
                    date: new Date().toISOString().split('T')[0],
                    class: '',
                    section: '',
                    students: []
                };
                this.initUI();
                this.setupAutoLock();
            }
            
            setupAutoLock() {
                let idleTime = 0;
                const idleInterval = setInterval(() => {
                    idleTime++;
                    const settings = storage.get('settings');
                    if (settings.autoLock && idleTime > 15) {
                        this.lockSystem();
                        idleTime = 0;
                    }
                }, 60000);
                
                const resetIdleTime = () => idleTime = 0;
                document.addEventListener('mousemove', resetIdleTime);
                document.addEventListener('keypress', resetIdleTime);
                document.addEventListener('click', resetIdleTime);
                document.addEventListener('touchstart', resetIdleTime);
            }
            
            initUI() {
                this.initEventListeners();
                this.updateDateTime();
                this.loadPage('dashboard');
                this.applyTheme();
                
                setInterval(() => this.updateDateTime(), 60000);
            }
            
            initEventListeners() {
                // Sidebar toggle
                document.getElementById('sidebarToggle').addEventListener('click', () => {
                    document.getElementById('sidebar').classList.toggle('collapsed');
                });
                
                // Navigation
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const page = link.getAttribute('data-page');
                        this.loadPage(page);
                        
                        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                        link.classList.add('active');
                    });
                });
                
                // Theme toggle
                document.getElementById('themeToggle').addEventListener('click', () => {
                    this.toggleTheme();
                });
                
                // Lock button
                document.getElementById('lockBtn').addEventListener('click', () => {
                    this.lockSystem();
                });
                
                // Export button
                document.getElementById('exportBtn').addEventListener('click', () => {
                    this.showExportModal();
                });
                
                // Import button
                document.getElementById('importBtn').addEventListener('click', () => {
                    this.showImportModal();
                });
                
                // Settings button
                document.getElementById('settingsBtn').addEventListener('click', () => {
                    this.loadPage('settings');
                });
                
                // PIN lock system
                document.getElementById('unlockBtn').addEventListener('click', () => {
                    this.unlockSystem();
                });
                
                document.getElementById('pinField').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.unlockSystem();
                    }
                });
                
                document.getElementById('resetPinBtn').addEventListener('click', () => {
                    this.resetPin();
                });
            }
            
            updateDateTime() {
                const now = new Date();
                const options = { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                };
                const dateTimeString = now.toLocaleDateString('en-US', options);
                document.getElementById('currentDateTime').textContent = dateTimeString;
            }
            
            applyTheme() {
                const settings = storage.get('settings');
                if (settings.theme === 'dark') {
                    document.body.classList.add('dark-mode');
                    document.getElementById('themeToggle').innerHTML = '<i class="fas fa-sun"></i>';
                } else {
                    document.body.classList.remove('dark-mode');
                    document.getElementById('themeToggle').innerHTML = '<i class="fas fa-moon"></i>';
                }
            }
            
            toggleTheme() {
                const settings = storage.get('settings');
                settings.theme = settings.theme === 'light' ? 'dark' : 'light';
                storage.set('settings', settings);
                this.applyTheme();
                this.showToast({ type: 'success', message: `Switched to ${settings.theme} mode` });
            }
            
            lockSystem() {
                document.getElementById('lockScreen').style.display = 'flex';
                document.getElementById('appContainer').style.display = 'none';
                document.getElementById('pinField').value = '';
                document.getElementById('pinField').focus();
            }
            
            unlockSystem() {
                const pinInput = document.getElementById('pinField').value;
                const settings = storage.get('settings');
                
                if (pinInput === settings.pin) {
                    document.getElementById('lockScreen').style.display = 'none';
                    document.getElementById('appContainer').style.display = 'flex';
                    this.showToast({ type: 'success', message: 'System unlocked' });
                } else {
                    this.showToast({ type: 'error', message: 'Incorrect PIN' });
                    document.getElementById('pinField').value = '';
                    document.getElementById('pinField').focus();
                }
            }
            
            resetPin() {
                const settings = storage.get('settings');
                settings.pin = '1234';
                storage.set('settings', settings);
                this.showToast({ type: 'success', message: 'PIN reset to 1234' });
                document.getElementById('pinField').value = '';
                document.getElementById('pinField').focus();
            }
            
            loadPage(page) {
                this.currentPage = page;
                
                document.querySelectorAll('.page').forEach(p => {
                    p.classList.remove('active');
                    p.style.display = 'none';
                });
                
                const pageElement = document.getElementById(`${page}Page`);
                if (pageElement) {
                    pageElement.style.display = 'block';
                    pageElement.classList.add('active');
                    this.loadPageContent(page);
                }
                
                const settings = storage.get('settings');
                document.getElementById('schoolName').textContent = settings.schoolName;
                document.getElementById('academicYear').textContent = `Academic Year: ${settings.academicYear}`;
                
                storage.updateStorageUsage();
            }
            
            loadPageContent(page) {
                switch(page) {
                    case 'dashboard':
                        this.loadDashboard();
                        break;
                    case 'students':
                        this.loadStudents();
                        break;
                    case 'teachers':
                        this.loadTeachers();
                        break;
                    case 'classes':
                        this.loadClasses();
                        break;
                    case 'attendance':
                        this.loadAttendance();
                        break;
                    case 'exams':
                        this.loadExams();
                        break;
                    case 'fees':
                        this.loadFees();
                        break;
                    case 'timetable':
                        this.loadTimetable();
                        break;
                    case 'notices':
                        this.loadNotices();
                        break;
                    case 'settings':
                        this.loadSettings();
                        break;
                }
            }
            
            loadDashboard() {
                const stats = storage.getDashboardStats();
                const students = storage.getStudents();
                const notices = storage.getNotices();
                
                const html = `
                    <div class="page-header">
                        <h1 class="page-title">Dashboard</h1>
                        <div class="page-actions">
                            <button class="btn btn-primary" id="addStudentBtn">
                                <i class="fas fa-user-plus"></i> Add Student
                            </button>
                            <button class="btn btn-success" id="markAttendanceBtn">
                                <i class="fas fa-clipboard-check"></i> Mark Attendance
                            </button>
                        </div>
                    </div>
                    
                    <div class="cards-container">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Total Students</h3>
                                <div class="card-icon students">
                                    <i class="fas fa-user-graduate"></i>
                                </div>
                            </div>
                            <div class="card-value">${stats.totalStudents}</div>
                            <div class="card-change positive">
                                <i class="fas fa-arrow-up"></i> ${stats.totalStudents} enrolled
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Total Teachers</h3>
                                <div class="card-icon teachers">
                                    <i class="fas fa-chalkboard-teacher"></i>
                                </div>
                            </div>
                            <div class="card-value">${stats.totalTeachers}</div>
                            <div class="card-change positive">
                                <i class="fas fa-arrow-up"></i> ${stats.totalTeachers} active
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Today's Attendance</h3>
                                <div class="card-icon attendance">
                                    <i class="fas fa-clipboard-check"></i>
                                </div>
                            </div>
                            <div class="card-value">${stats.todayAttendance}</div>
                            <div class="card-change ${stats.todayAttendance > 0 ? 'positive' : 'warning'}">
                                ${stats.todayAttendance > 0 ? '<i class="fas fa-arrow-up"></i> Marked' : '<i class="fas fa-clock"></i> Pending'}
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Pending Fees</h3>
                                <div class="card-icon fees">
                                    <i class="fas fa-money-check-alt"></i>
                                </div>
                            </div>
                            <div class="card-value">${stats.pendingFees}</div>
                            <div class="card-change ${stats.pendingFees > 0 ? 'negative' : 'positive'}">
                                ${stats.pendingFees > 0 ? '<i class="fas fa-exclamation-circle"></i> Due' : '<i class="fas fa-check-circle"></i> Clear'}
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Active Notices</h3>
                                <div class="card-icon notices">
                                    <i class="fas fa-bullhorn"></i>
                                </div>
                            </div>
                            <div class="card-value">${stats.activeNotices}</div>
                            <div class="card-change info">
                                <i class="fas fa-bell"></i> Active
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Total Classes</h3>
                                <div class="card-icon classes">
                                    <i class="fas fa-school"></i>
                                </div>
                            </div>
                            <div class="card-value">${stats.totalClasses}</div>
                            <div class="card-change positive">
                                <i class="fas fa-arrow-up"></i> Running
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <div class="table-header">
                            <h3 class="table-title">Recent Students</h3>
                            <div class="table-controls">
                                <div class="search-box">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="searchStudents" placeholder="Search students...">
                                </div>
                                <button class="btn btn-primary btn-sm" id="viewAllStudents">
                                    <i class="fas fa-list"></i> View All
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table id="studentsTable">
                                <thead>
                                    <tr>
                                        <th>Admission No.</th>
                                        <th>Name</th>
                                        <th>Class</th>
                                        <th>Section</th>
                                        <th>Roll No.</th>
                                        <th>Parent Contact</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${students.slice(0, 5).map(student => `
                                        <tr>
                                            <td>${student.admissionNo}</td>
                                            <td><strong>${student.name}</strong></td>
                                            <td><span class="badge badge-primary">${student.class}</span></td>
                                            <td>${student.section}</td>
                                            <td>${student.rollNo}</td>
                                            <td>${student.phone}</td>
                                            <td>
                                                <button class="btn btn-secondary btn-sm view-student" data-id="${student.id}">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-primary btn-sm edit-student" data-id="${student.id}">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <div class="table-header">
                            <h3 class="table-title">Recent Notices</h3>
                            <div class="table-controls">
                                <button class="btn btn-primary btn-sm" id="addNoticeBtn">
                                    <i class="fas fa-plus"></i> Add Notice
                                </button>
                            </div>
                        </div>
                        <div class="notices-list">
                            ${notices.slice(0, 3).map(notice => `
                                <div class="notice-card ${notice.priority || ''}">
                                    <div class="notice-header">
                                        <h4 class="notice-title">${notice.title}</h4>
                                        <span class="notice-date">${new Date(notice.date).toLocaleDateString()}</span>
                                    </div>
                                    <div class="notice-content">
                                        ${notice.content}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                document.getElementById('dashboardPage').innerHTML = html;
                
                // Add event listeners
                const addStudentBtn = document.getElementById('addStudentBtn');
                if (addStudentBtn) addStudentBtn.addEventListener('click', () => this.showStudentForm());
                
                const markAttendanceBtn = document.getElementById('markAttendanceBtn');
                if (markAttendanceBtn) markAttendanceBtn.addEventListener('click', () => this.loadPage('attendance'));
                
                const viewAllStudents = document.getElementById('viewAllStudents');
                if (viewAllStudents) viewAllStudents.addEventListener('click', () => this.loadPage('students'));
                
                const addNoticeBtn = document.getElementById('addNoticeBtn');
                if (addNoticeBtn) addNoticeBtn.addEventListener('click', () => this.showNoticeForm());
                
                // Student action buttons
                document.querySelectorAll('.view-student').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        this.showStudentDetails(id);
                    });
                });
                
                document.querySelectorAll('.edit-student').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        this.showStudentForm(id);
                    });
                });
                
                // Search functionality
                const searchInput = document.getElementById('searchStudents');
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        const searchTerm = e.target.value.toLowerCase();
                        const rows = document.querySelectorAll('#studentsTable tbody tr');
                        
                        rows.forEach(row => {
                            const text = row.textContent.toLowerCase();
                            row.style.display = text.includes(searchTerm) ? '' : 'none';
                        });
                    });
                }
            }
            
            loadStudents() {
                const students = storage.getStudents();
                const html = `
                    <div class="page-header">
                        <h1 class="page-title">Students Management</h1>
                        <div class="page-actions">
                            <button class="btn btn-primary" id="addNewStudentBtn">
                                <i class="fas fa-user-plus"></i> Add Student
                            </button>
                            <button class="btn btn-success" id="exportStudentsBtn">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <div class="table-header">
                            <h3 class="table-title">All Students (${students.length})</h3>
                            <div class="table-controls">
                                <div class="search-box">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="searchAllStudents" placeholder="Search students...">
                                </div>
                                <select class="form-control" id="filterClass" style="width: 150px;">
                                    <option value="">All Classes</option>
                                    ${[...new Set(students.map(s => s.class))].map(cls => `
                                        <option value="${cls}">Class ${cls}</option>
                                    `).join('')}
                                </select>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Admission No.</th>
                                        <th>Name</th>
                                        <th>Class</th>
                                        <th>Section</th>
                                        <th>Roll No.</th>
                                        <th>Gender</th>
                                        <th>Parent Contact</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${students.map(student => `
                                        <tr>
                                            <td><strong>${student.admissionNo}</strong></td>
                                            <td>${student.name}</td>
                                            <td><span class="badge badge-primary">${student.class}</span></td>
                                            <td>${student.section}</td>
                                            <td>${student.rollNo}</td>
                                            <td>${student.gender}</td>
                                            <td>${student.phone}</td>
                                            <td>
                                                <button class="btn btn-secondary btn-sm view-student-btn" data-id="${student.id}" title="View">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-primary btn-sm edit-student-btn" data-id="${student.id}" title="Edit">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-danger btn-sm delete-student-btn" data-id="${student.id}" title="Delete">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                document.getElementById('studentsPage').innerHTML = html;
                
                // Add event listeners
                const addNewStudentBtn = document.getElementById('addNewStudentBtn');
                if (addNewStudentBtn) addNewStudentBtn.addEventListener('click', () => this.showStudentForm());
                
                const exportStudentsBtn = document.getElementById('exportStudentsBtn');
                if (exportStudentsBtn) exportStudentsBtn.addEventListener('click', () => this.exportStudents());
                
                // Search functionality
                const searchInput = document.getElementById('searchAllStudents');
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        const searchTerm = e.target.value.toLowerCase();
                        const rows = document.querySelectorAll('#studentsPage tbody tr');
                        
                        rows.forEach(row => {
                            const text = row.textContent.toLowerCase();
                            row.style.display = text.includes(searchTerm) ? '' : 'none';
                        });
                    });
                }
                
                // Filter functionality
                const filterClass = document.getElementById('filterClass');
                if (filterClass) {
                    filterClass.addEventListener('change', (e) => {
                        const selectedClass = e.target.value;
                        const rows = document.querySelectorAll('#studentsPage tbody tr');
                        
                        rows.forEach(row => {
                            const studentClass = row.cells[2].textContent.replace('Class ', '').trim();
                            if (!selectedClass || studentClass === selectedClass) {
                                row.style.display = '';
                            } else {
                                row.style.display = 'none';
                            }
                        });
                    });
                }
                
                // Student action buttons
                document.querySelectorAll('.view-student-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        this.showStudentDetails(id);
                    });
                });
                
                document.querySelectorAll('.edit-student-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        this.showStudentForm(id);
                    });
                });
                
                document.querySelectorAll('.delete-student-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        if (confirm('Are you sure you want to delete this student?')) {
                            storage.deleteStudent(id);
                            this.loadPage('students');
                            this.showToast({ type: 'success', message: 'Student deleted successfully' });
                        }
                    });
                });
            }
            
            showStudentForm(studentId = null) {
                const students = storage.getStudents();
                let student = null;
                
                if (studentId) {
                    student = students.find(s => s.id === studentId);
                }
                
                const modalHtml = `
                    <div class="modal-overlay" id="studentModalOverlay">
                        <div class="modal">
                            <div class="modal-header">
                                <h3 class="modal-title">${student ? 'Edit Student' : 'Add New Student'}</h3>
                                <button class="modal-close" id="closeStudentModal">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body">
                                <form id="studentForm">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Admission Number</label>
                                            <input type="text" class="form-control" id="admissionNo" 
                                                   value="${student?.admissionNo || ''}">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Roll Number</label>
                                            <input type="text" class="form-control" id="rollNo" 
                                                   value="${student?.rollNo || ''}">
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Full Name *</label>
                                            <input type="text" class="form-control" id="studentName" 
                                                   value="${student?.name || ''}" required>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Gender *</label>
                                            <select class="form-control" id="gender" required>
                                                <option value="">Select Gender</option>
                                                <option value="Male" ${student?.gender === 'Male' ? 'selected' : ''}>Male</option>
                                                <option value="Female" ${student?.gender === 'Female' ? 'selected' : ''}>Female</option>
                                                <option value="Other" ${student?.gender === 'Other' ? 'selected' : ''}>Other</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Class *</label>
                                            <select class="form-control" id="studentClass" required>
                                                <option value="">Select Class</option>
                                                ${[...new Set(students.map(s => s.class))].sort((a, b) => a - b).map(cls => `
                                                    <option value="${cls}" ${student?.class === cls ? 'selected' : ''}>Class ${cls}</option>
                                                `).join('')}
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Section *</label>
                                            <input type="text" class="form-control" id="section" 
                                                   value="${student?.section || 'A'}" required>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Date of Birth</label>
                                            <input type="date" class="form-control" id="dob" 
                                                   value="${student?.dob || ''}">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Parent/Guardian Name</label>
                                            <input type="text" class="form-control" id="parentName" 
                                                   value="${student?.parentName || ''}">
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Contact Number</label>
                                            <input type="tel" class="form-control" id="phone" 
                                                   value="${student?.phone || ''}">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Email Address</label>
                                            <input type="email" class="form-control" id="email" 
                                                   value="${student?.email || ''}">
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Address</label>
                                        <textarea class="form-control" id="address" rows="2">${student?.address || ''}</textarea>
                                    </div>
                                    
                                    <input type="hidden" id="studentId" value="${student?.id || ''}">
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" id="cancelStudentBtn">Cancel</button>
                                <button class="btn btn-primary" id="saveStudentBtn">
                                    ${student ? 'Update Student' : 'Save Student'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('modalContainer').innerHTML = modalHtml;
                
                // Event listeners
                document.getElementById('closeStudentModal').addEventListener('click', () => {
                    document.getElementById('studentModalOverlay').remove();
                });
                
                document.getElementById('cancelStudentBtn').addEventListener('click', () => {
                    document.getElementById('studentModalOverlay').remove();
                });
                
                document.getElementById('saveStudentBtn').addEventListener('click', () => {
                    this.saveStudent();
                });
            }
            
            saveStudent() {
                const student = {
                    id: document.getElementById('studentId').value || null,
                    admissionNo: document.getElementById('admissionNo').value,
                    name: document.getElementById('studentName').value,
                    class: document.getElementById('studentClass').value,
                    section: document.getElementById('section').value,
                    rollNo: document.getElementById('rollNo').value,
                    gender: document.getElementById('gender').value,
                    dob: document.getElementById('dob').value,
                    parentName: document.getElementById('parentName').value,
                    phone: document.getElementById('phone').value,
                    email: document.getElementById('email').value,
                    address: document.getElementById('address').value
                };
                
                // Validation
                if (!student.name || !student.class || !student.section || !student.gender) {
                    this.showToast({ type: 'error', message: 'Please fill all required fields' });
                    return;
                }
                
                if (storage.saveStudent(student)) {
                    this.showToast({ type: 'success', message: `Student ${student.id ? 'updated' : 'added'} successfully` });
                    document.getElementById('studentModalOverlay').remove();
                    this.loadPage('students');
                } else {
                    this.showToast({ type: 'error', message: 'Failed to save student' });
                }
            }
            
            showStudentDetails(studentId) {
                const student = storage.getStudents().find(s => s.id === studentId);
                if (!student) return;
                
                const modalHtml = `
                    <div class="modal-overlay" id="studentDetailsModal">
                        <div class="modal" style="max-width: 800px;">
                            <div class="modal-header">
                                <h3 class="modal-title">Student Details</h3>
                                <button class="modal-close" id="closeDetailsModal">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body">
                                <div class="profile-header">
                                    <div class="profile-avatar">
                                        ${student.name.split(' ').map(n => n[0]).join('').toUpperCase()}
                                    </div>
                                    <div class="profile-info">
                                        <h2>${student.name}</h2>
                                        <p><strong>Admission No:</strong> ${student.admissionNo}</p>
                                        <p><strong>Class:</strong> ${student.class} - Section ${student.section}</p>
                                        <p><strong>Roll No:</strong> ${student.rollNo}</p>
                                        <p><strong>Gender:</strong> ${student.gender}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" id="closeDetailsBtn">Close</button>
                                <button class="btn btn-primary" id="editStudentDetailsBtn" data-id="${student.id}">
                                    <i class="fas fa-edit"></i> Edit Student
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('modalContainer').innerHTML = modalHtml;
                
                // Close buttons
                document.getElementById('closeDetailsModal').addEventListener('click', () => {
                    document.getElementById('studentDetailsModal').remove();
                });
                
                document.getElementById('closeDetailsBtn').addEventListener('click', () => {
                    document.getElementById('studentDetailsModal').remove();
                });
                
                document.getElementById('editStudentDetailsBtn').addEventListener('click', () => {
                    document.getElementById('studentDetailsModal').remove();
                    this.showStudentForm(studentId);
                });
            }
            
            exportStudents() {
                const students = storage.getStudents();
                const csv = this.convertToCSV(students);
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `students-export-${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.showToast({ type: 'success', message: 'Students exported successfully' });
            }
            
            convertToCSV(data) {
                if (data.length === 0) return '';
                
                const headers = Object.keys(data[0]);
                const csvRows = [];
                
                csvRows.push(headers.join(','));
                
                for (const row of data) {
                    const values = headers.map(header => {
                        const escaped = ('' + row[header]).replace(/"/g, '""');
                        return `"${escaped}"`;
                    });
                    csvRows.push(values.join(','));
                }
                
                return csvRows.join('\n');
            }
            
            loadTeachers() {
                const teachers = storage.getTeachers();
                
                const html = `
                    <div class="page-header">
                        <h1 class="page-title">Teachers Management</h1>
                        <div class="page-actions">
                            <button class="btn btn-primary" id="addTeacherBtn">
                                <i class="fas fa-user-plus"></i> Add Teacher
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <div class="table-header">
                            <h3 class="table-title">All Teachers (${teachers.length})</h3>
                            <div class="table-controls">
                                <div class="search-box">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="searchTeachers" placeholder="Search teachers...">
                                </div>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Employee ID</th>
                                        <th>Name</th>
                                        <th>Subject</th>
                                        <th>Classes</th>
                                        <th>Qualification</th>
                                        <th>Contact</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${teachers.map(teacher => `
                                        <tr>
                                            <td><strong>${teacher.employeeId}</strong></td>
                                            <td>${teacher.name}</td>
                                            <td><span class="badge badge-primary">${teacher.subject}</span></td>
                                            <td>${Array.isArray(teacher.classes) ? teacher.classes.join(', ') : teacher.classes}</td>
                                            <td>${teacher.qualification || 'N/A'}</td>
                                            <td>${teacher.phone || 'N/A'}<br><small>${teacher.email || ''}</small></td>
                                            <td>
                                                <button class="btn btn-primary btn-sm edit-teacher-btn" data-id="${teacher.id}">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-danger btn-sm delete-teacher-btn" data-id="${teacher.id}">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                document.getElementById('teachersPage').innerHTML = html;
                
                // Add event listeners
                document.getElementById('addTeacherBtn')?.addEventListener('click', () => this.showTeacherForm());
                
                // Search functionality
                document.getElementById('searchTeachers')?.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const rows = document.querySelectorAll('#teachersPage tbody tr');
                    
                    rows.forEach(row => {
                        const text = row.textContent.toLowerCase();
                        row.style.display = text.includes(searchTerm) ? '' : 'none';
                    });
                });
                
                // Teacher action buttons
                document.querySelectorAll('.edit-teacher-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        this.showTeacherForm(id);
                    });
                });
                
                document.querySelectorAll('.delete-teacher-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        if (confirm('Are you sure you want to delete this teacher?')) {
                            storage.deleteTeacher(id);
                            this.loadPage('teachers');
                            this.showToast({ type: 'success', message: 'Teacher deleted successfully' });
                        }
                    });
                });
            }
            
            showTeacherForm(teacherId = null) {
                const teachers = storage.getTeachers();
                let teacher = null;
                
                if (teacherId) {
                    teacher = teachers.find(t => t.id === teacherId);
                }
                
                const modalHtml = `
                    <div class="modal-overlay" id="teacherModalOverlay">
                        <div class="modal">
                            <div class="modal-header">
                                <h3 class="modal-title">${teacher ? 'Edit Teacher' : 'Add New Teacher'}</h3>
                                <button class="modal-close" id="closeTeacherModal">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body">
                                <form id="teacherForm">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Employee ID</label>
                                            <input type="text" class="form-control" id="employeeId" 
                                                   value="${teacher?.employeeId || ''}">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Full Name *</label>
                                            <input type="text" class="form-control" id="teacherName" 
                                                   value="${teacher?.name || ''}" required>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Subject *</label>
                                            <input type="text" class="form-control" id="subject" 
                                                   value="${teacher?.subject || ''}" required>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Classes Assigned</label>
                                            <input type="text" class="form-control" id="classes" 
                                                   value="${Array.isArray(teacher?.classes) ? teacher.classes.join(', ') : teacher?.classes || ''}"
                                                   placeholder="e.g., 10, 11, 12">
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Email Address</label>
                                            <input type="email" class="form-control" id="teacherEmail" 
                                                   value="${teacher?.email || ''}">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Phone Number</label>
                                            <input type="tel" class="form-control" id="teacherPhone" 
                                                   value="${teacher?.phone || ''}">
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Qualification</label>
                                            <input type="text" class="form-control" id="qualification" 
                                                   value="${teacher?.qualification || ''}">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Experience</label>
                                            <input type="text" class="form-control" id="experience" 
                                                   value="${teacher?.experience || ''}" 
                                                   placeholder="e.g., 5 years">
                                        </div>
                                    </div>
                                    
                                    <input type="hidden" id="teacherId" value="${teacher?.id || ''}">
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" id="cancelTeacherBtn">Cancel</button>
                                <button class="btn btn-primary" id="saveTeacherBtn">
                                    ${teacher ? 'Update Teacher' : 'Save Teacher'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('modalContainer').innerHTML = modalHtml;
                
                // Event listeners
                document.getElementById('closeTeacherModal').addEventListener('click', () => {
                    document.getElementById('teacherModalOverlay').remove();
                });
                
                document.getElementById('cancelTeacherBtn').addEventListener('click', () => {
                    document.getElementById('teacherModalOverlay').remove();
                });
                
                document.getElementById('saveTeacherBtn').addEventListener('click', () => {
                    this.saveTeacher();
                });
            }
            
            saveTeacher() {
                const teacher = {
                    id: document.getElementById('teacherId').value || null,
                    employeeId: document.getElementById('employeeId').value,
                    name: document.getElementById('teacherName').value,
                    subject: document.getElementById('subject').value,
                    classes: document.getElementById('classes').value.split(',').map(c => c.trim()).filter(c => c),
                    email: document.getElementById('teacherEmail').value,
                    phone: document.getElementById('teacherPhone').value,
                    qualification: document.getElementById('qualification').value,
                    experience: document.getElementById('experience').value
                };
                
                // Validation
                if (!teacher.name || !teacher.subject) {
                    this.showToast({ type: 'error', message: 'Please fill all required fields' });
                    return;
                }
                
                if (storage.saveTeacher(teacher)) {
                    this.showToast({ type: 'success', message: `Teacher ${teacher.id ? 'updated' : 'added'} successfully` });
                    document.getElementById('teacherModalOverlay').remove();
                    this.loadPage('teachers');
                } else {
                    this.showToast({ type: 'error', message: 'Failed to save teacher' });
                }
            }
            
            loadClasses() {
                const classes = storage.getClasses();
                const subjects = storage.getSubjects();
                
                const html = `
                    <div class="page-header">
                        <h1 class="page-title">Classes & Subjects</h1>
                        <div class="page-actions">
                            <button class="btn btn-primary" id="addClassBtn">
                                <i class="fas fa-plus"></i> Add Class
                            </button>
                            <button class="btn btn-success" id="addSubjectBtn">
                                <i class="fas fa-book"></i> Add Subject
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-container" style="margin-bottom: 2rem;">
                        <div class="table-header">
                            <h3 class="table-title">Classes (${classes.length})</h3>
                        </div>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Class Name</th>
                                        <th>Sections</th>
                                        <th>Subjects</th>
                                        <th>Total Students</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${classes.map(cls => {
                                        const students = storage.getStudents().filter(s => s.class == cls.name.split(' ')[1]);
                                        return `
                                            <tr>
                                                <td><strong>${cls.name}</strong></td>
                                                <td>
                                                    ${(Array.isArray(cls.sections) ? cls.sections : [cls.sections]).map(sec => `
                                                        <span class="badge badge-secondary">${sec}</span>
                                                    `).join(' ')}
                                                </td>
                                                <td>
                                                    ${(Array.isArray(cls.subjects) ? cls.subjects : [cls.subjects]).slice(0, 3).map(sub => `
                                                        <span class="badge badge-primary">${sub}</span>
                                                    `).join(' ')}
                                                    ${(Array.isArray(cls.subjects) ? cls.subjects.length : 1) > 3 ? '...' : ''}
                                                </td>
                                                <td><strong>${students.length}</strong> students</td>
                                                <td>
                                                    <button class="btn btn-primary btn-sm edit-class-btn" data-id="${cls.id}">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <div class="table-header">
                            <h3 class="table-title">Subjects (${subjects.length})</h3>
                        </div>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Subject Name</th>
                                        <th>Subject Code</th>
                                        <th>Teacher</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${subjects.map(subject => `
                                        <tr>
                                            <td><strong>${subject.name}</strong></td>
                                            <td>${subject.code || 'N/A'}</td>
                                            <td>${subject.teacher || 'Not assigned'}</td>
                                            <td>
                                                <button class="btn btn-primary btn-sm edit-subject-btn" data-id="${subject.id}">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                document.getElementById('classesPage').innerHTML = html;
                
                // Add event listeners
                document.getElementById('addClassBtn')?.addEventListener('click', () => this.showClassForm());
                document.getElementById('addSubjectBtn')?.addEventListener('click', () => this.showSubjectForm());
                
                // Class action buttons
                document.querySelectorAll('.edit-class-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        this.showClassForm(id);
                    });
                });
                
                // Subject action buttons
                document.querySelectorAll('.edit-subject-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        this.showSubjectForm(id);
                    });
                });
            }
            
            showClassForm(classId = null) {
                const classes = storage.getClasses();
                let cls = null;
                
                if (classId) {
                    cls = classes.find(c => c.id === classId);
                }
                
                const modalHtml = `
                    <div class="modal-overlay" id="classModalOverlay">
                        <div class="modal">
                            <div class="modal-header">
                                <h3 class="modal-title">${cls ? 'Edit Class' : 'Add New Class'}</h3>
                                <button class="modal-close" id="closeClassModal">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body">
                                <form id="classForm">
                                    <div class="form-group">
                                        <label class="form-label">Class Name *</label>
                                        <input type="text" class="form-control" id="className" 
                                               value="${cls?.name || ''}" 
                                               placeholder="e.g., Class 10" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Sections *</label>
                                        <input type="text" class="form-control" id="sections" 
                                               value="${Array.isArray(cls?.sections) ? cls.sections.join(', ') : cls?.sections || ''}"
                                               placeholder="e.g., A, B, C" required>
                                        <small class="text-muted">Enter sections separated by commas</small>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Subjects</label>
                                        <input type="text" class="form-control" id="classSubjects" 
                                               value="${Array.isArray(cls?.subjects) ? cls.subjects.join(', ') : cls?.subjects || ''}"
                                               placeholder="e.g., Math, Science, English">
                                        <small class="text-muted">Enter subjects separated by commas</small>
                                    </div>
                                    
                                    <input type="hidden" id="classId" value="${cls?.id || ''}">
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" id="cancelClassBtn">Cancel</button>
                                <button class="btn btn-primary" id="saveClassBtn">
                                    ${cls ? 'Update Class' : 'Save Class'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('modalContainer').innerHTML = modalHtml;
                
                // Event listeners
                document.getElementById('closeClassModal').addEventListener('click', () => {
                    document.getElementById('classModalOverlay').remove();
                });
                
                document.getElementById('cancelClassBtn').addEventListener('click', () => {
                    document.getElementById('classModalOverlay').remove();
                });
                
                document.getElementById('saveClassBtn').addEventListener('click', () => {
                    this.saveClass();
                });
            }
            
            saveClass() {
                const cls = {
                    id: document.getElementById('classId').value || null,
                    name: document.getElementById('className').value,
                    sections: document.getElementById('sections').value.split(',').map(s => s.trim()).filter(s => s),
                    subjects: document.getElementById('classSubjects').value.split(',').map(s => s.trim()).filter(s => s)
                };
                
                // Validation
                if (!cls.name || !cls.sections || cls.sections.length === 0) {
                    this.showToast({ type: 'error', message: 'Please fill all required fields' });
                    return;
                }
                
                if (storage.saveClass(cls)) {
                    this.showToast({ type: 'success', message: `Class ${cls.id ? 'updated' : 'added'} successfully` });
                    document.getElementById('classModalOverlay').remove();
                    this.loadPage('classes');
                } else {
                    this.showToast({ type: 'error', message: 'Failed tosave class' });
}
}        showSubjectForm(subjectId = null) {
            const subjects = storage.getSubjects();
            const teachers = storage.getTeachers();
            let subject = null;
            
            if (subjectId) {
                subject = subjects.find(s => s.id === subjectId);
            }
            
            const modalHtml = `
                <div class="modal-overlay" id="subjectModalOverlay">
                    <div class="modal">
                        <div class="modal-header">
                            <h3 class="modal-title">${subject ? 'Edit Subject' : 'Add New Subject'}</h3>
                            <button class="modal-close" id="closeSubjectModal">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form id="subjectForm">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Subject Name *</label>
                                        <input type="text" class="form-control" id="subjectName" 
                                               value="${subject?.name || ''}" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Subject Code</label>
                                        <input type="text" class="form-control" id="subjectCode" 
                                               value="${subject?.code || ''}">
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Teacher</label>
                                    <select class="form-control" id="subjectTeacher">
                                        <option value="">Select Teacher</option>
                                        ${teachers.map(teacher => `
                                            <option value="${teacher.name}" ${subject?.teacher === teacher.name ? 'selected' : ''}>
                                                ${teacher.name} (${teacher.subject})
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>
                                
                                <input type="hidden" id="subjectId" value="${subject?.id || ''}">
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="cancelSubjectBtn">Cancel</button>
                            <button class="btn btn-primary" id="saveSubjectBtn">
                                ${subject ? 'Update Subject' : 'Save Subject'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContainer').innerHTML = modalHtml;
            
            // Event listeners
            document.getElementById('closeSubjectModal').addEventListener('click', () => {
                document.getElementById('subjectModalOverlay').remove();
            });
            
            document.getElementById('cancelSubjectBtn').addEventListener('click', () => {
                document.getElementById('subjectModalOverlay').remove();
            });
            
            document.getElementById('saveSubjectBtn').addEventListener('click', () => {
                this.saveSubject();
            });
        }
        
        saveSubject() {
            const subject = {
                id: document.getElementById('subjectId').value || null,
                name: document.getElementById('subjectName').value,
                code: document.getElementById('subjectCode').value,
                teacher: document.getElementById('subjectTeacher').value
            };
            
            // Validation
            if (!subject.name) {
                this.showToast({ type: 'error', message: 'Please enter subject name' });
                return;
            }
            
            if (storage.saveSubject(subject)) {
                this.showToast({ type: 'success', message: `Subject ${subject.id ? 'updated' : 'added'} successfully` });
                document.getElementById('subjectModalOverlay').remove();
                this.loadPage('classes');
            } else {
                this.showToast({ type: 'error', message: 'Failed to save subject' });
            }
        }
        
        loadAttendance() {
            const classes = storage.getClasses();
            const students = storage.getStudents();
            const today = new Date().toISOString().split('T')[0];
            
            const html = `
                <div class="page-header">
                    <h1 class="page-title">Attendance Management</h1>
                    <div class="page-actions">
                        <div class="form-row" style="margin-bottom: 0;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <input type="date" class="form-control" id="attendanceDate" value="${today}">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <select class="form-control" id="attendanceClass">
                                    <option value="">Select Class</option>
                                    ${[...new Set(students.map(s => s.class))].sort((a, b) => a - b).map(cls => `
                                        <option value="${cls}">Class ${cls}</option>
                                    `).join('')}
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <select class="form-control" id="attendanceSection">
                                    <option value="">Select Section</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" id="loadAttendanceBtn">
                                <i class="fas fa-search"></i> Load
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <h3 class="table-title">Mark Attendance</h3>
                        <div class="table-controls">
                            <button class="btn btn-success" id="markAllPresent">
                                <i class="fas fa-check-circle"></i> Mark All Present
                            </button>
                            <button class="btn btn-danger" id="markAllAbsent">
                                <i class="fas fa-times-circle"></i> Mark All Absent
                            </button>
                        </div>
                    </div>
                    <div class="attendance-grid" id="attendanceGrid">
                        <div class="no-data" style="text-align: center; padding: 3rem; color: var(--text-light);">
                            <i class="fas fa-clipboard-list fa-3x" style="margin-bottom: 1rem;"></i>
                            <p>Select date, class and section to mark attendance</p>
                        </div>
                    </div>
                    <div class="table-footer" style="padding: 1.5rem; border-top: 1px solid var(--border-color); display: none;" id="attendanceFooter">
                        <button class="btn btn-primary btn-lg" id="saveAttendanceBtn" style="width: 100%;">
                            <i class="fas fa-save"></i> Save Attendance
                        </button>
                    </div>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <h3 class="table-title">Recent Attendance Records</h3>
                        <div class="table-controls">
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" id="searchAttendance" placeholder="Search attendance...">
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table id="attendanceTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Class</th>
                                    <th>Section</th>
                                    <th>Present</th>
                                    <th>Absent</th>
                                    <th>Total</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${storage.getAttendance().slice(0, 10).map(record => {
                                    const presentCount = record.students?.filter(s => s.status === 'present').length || 0;
                                    const totalCount = record.students?.length || 0;
                                    const absentCount = totalCount - presentCount;
                                    return `
                                        <tr>
                                            <td>${new Date(record.date).toLocaleDateString()}</td>
                                            <td>Class ${record.class}</td>
                                            <td>${record.section}</td>
                                            <td><span class="badge badge-success">${presentCount}</span></td>
                                            <td><span class="badge badge-danger">${absentCount}</span></td>
                                            <td><strong>${totalCount}</strong></td>
                                            <td>
                                                <button class="btn btn-secondary btn-sm view-attendance-btn" data-date="${record.date}" data-class="${record.class}" data-section="${record.section}">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-primary btn-sm edit-attendance-btn" data-date="${record.date}" data-class="${record.class}" data-section="${record.section}">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            document.getElementById('attendancePage').innerHTML = html;
            
            // Event listeners
            const loadBtn = document.getElementById('loadAttendanceBtn');
            if (loadBtn) loadBtn.addEventListener('click', () => this.loadAttendanceForClass());
            
            const classSelect = document.getElementById('attendanceClass');
            if (classSelect) {
                classSelect.addEventListener('change', (e) => {
                    const selectedClass = e.target.value;
                    const sectionSelect = document.getElementById('attendanceSection');
                    
                    if (selectedClass) {
                        const sections = [...new Set(storage.getStudents()
                            .filter(s => s.class == selectedClass)
                            .map(s => s.section))];
                        
                        sectionSelect.innerHTML = '<option value="">Select Section</option>' +
                            sections.map(sec => `<option value="${sec}">Section ${sec}</option>`).join('');
                    } else {
                        sectionSelect.innerHTML = '<option value="">Select Section</option>';
                    }
                });
            }
            
            // Mark all buttons
            const markAllPresent = document.getElementById('markAllPresent');
            if (markAllPresent) {
                markAllPresent.addEventListener('click', () => {
                    document.querySelectorAll('.attendance-card').forEach(card => {
                        card.classList.remove('absent', 'selected');
                        card.classList.add('present', 'selected');
                        card.querySelector('.attendance-status').textContent = 'Present';
                        card.querySelector('.attendance-status').className = 'attendance-status badge badge-success';
                    });
                });
            }
            
            const markAllAbsent = document.getElementById('markAllAbsent');
            if (markAllAbsent) {
                markAllAbsent.addEventListener('click', () => {
                    document.querySelectorAll('.attendance-card').forEach(card => {
                        card.classList.remove('present', 'selected');
                        card.classList.add('absent', 'selected');
                        card.querySelector('.attendance-status').textContent = 'Absent';
                        card.querySelector('.attendance-status').className = 'attendance-status badge badge-danger';
                    });
                });
            }
            
            // Save attendance button
            const saveAttendanceBtn = document.getElementById('saveAttendanceBtn');
            if (saveAttendanceBtn) {
                saveAttendanceBtn.addEventListener('click', () => this.saveAttendance());
            }
            
            // View attendance buttons
            document.querySelectorAll('.view-attendance-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const date = e.currentTarget.getAttribute('data-date');
                    const cls = e.currentTarget.getAttribute('data-class');
                    const section = e.currentTarget.getAttribute('data-section');
                    this.viewAttendance(date, cls, section);
                });
            });
            
            // Edit attendance buttons
            document.querySelectorAll('.edit-attendance-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const date = e.currentTarget.getAttribute('data-date');
                    const cls = e.currentTarget.getAttribute('data-class');
                    const section = e.currentTarget.getAttribute('data-section');
                    
                    document.getElementById('attendanceDate').value = date;
                    document.getElementById('attendanceClass').value = cls;
                    
                    // Trigger change event to load sections
                    const event = new Event('change');
                    document.getElementById('attendanceClass').dispatchEvent(event);
                    
                    setTimeout(() => {
                        document.getElementById('attendanceSection').value = section;
                        this.loadAttendanceForClass();
                    }, 100);
                });
            });
        }
        
        loadAttendanceForClass() {
            const date = document.getElementById('attendanceDate').value;
            const cls = document.getElementById('attendanceClass').value;
            const section = document.getElementById('attendanceSection').value;
            
            if (!date || !cls || !section) {
                this.showToast({ type: 'error', message: 'Please select date, class and section' });
                return;
            }
            
            const students = storage.getStudents()
                .filter(s => s.class == cls && s.section === section)
                .sort((a, b) => a.rollNo - b.rollNo);
            
            if (students.length === 0) {
                this.showToast({ type: 'error', message: 'No students found for this class and section' });
                return;
            }
            
            // Check existing attendance
            const existingAttendance = storage.getAttendanceForClass(date, cls, section);
            const attendanceStudents = existingAttendance?.students || [];
            
            const gridHtml = students.map(student => {
                const existingRecord = attendanceStudents.find(s => s.studentId === student.id);
                const status = existingRecord?.status || 'absent';
                const isSelected = existingRecord ? 'selected' : '';
                
                return `
                    <div class="attendance-card ${status} ${isSelected}" data-student-id="${student.id}">
                        <div class="attendance-avatar">
                            ${student.name.split(' ').map(n => n[0]).join('').toUpperCase()}
                        </div>
                        <div class="attendance-name">${student.name}</div>
                        <div class="attendance-roll">Roll: ${student.rollNo}</div>
                        <div class="attendance-status badge ${status === 'present' ? 'badge-success' : 'badge-danger'}">
                            ${status === 'present' ? 'Present' : 'Absent'}
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('attendanceGrid').innerHTML = gridHtml;
            document.getElementById('attendanceFooter').style.display = 'block';
            
            // Update current attendance
            this.currentAttendance = {
                date: date,
                class: cls,
                section: section,
                students: students.map(student => {
                    const existingRecord = attendanceStudents.find(s => s.studentId === student.id);
                    return {
                        studentId: student.id,
                        id: student.id,
                        name: student.name,
                        rollNo: student.rollNo,
                        status: existingRecord?.status || 'absent'
                    };
                })
            };
            
            // Add click event to attendance cards
            document.querySelectorAll('.attendance-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    const studentId = e.currentTarget.getAttribute('data-student-id');
                    const card = e.currentTarget;
                    const isPresent = card.classList.contains('present');
                    
                    if (isPresent) {
                        card.classList.remove('present');
                        card.classList.add('absent');
                        card.querySelector('.attendance-status').textContent = 'Absent';
                        card.querySelector('.attendance-status').className = 'attendance-status badge badge-danger';
                    } else {
                        card.classList.remove('absent');
                        card.classList.add('present');
                        card.querySelector('.attendance-status').textContent = 'Present';
                        card.querySelector('.attendance-status').className = 'attendance-status badge badge-success';
                    }
                    
                    card.classList.add('selected');
                    
                    // Update current attendance
                    const studentIndex = this.currentAttendance.students.findIndex(s => s.studentId === studentId);
                    if (studentIndex !== -1) {
                        this.currentAttendance.students[studentIndex].status = isPresent ? 'absent' : 'present';
                    }
                });
            });
        }
        
        saveAttendance() {
            if (this.currentAttendance.students.length === 0) {
                this.showToast({ type: 'error', message: 'No attendance data to save' });
                return;
            }
            
            const attendance = {
                date: this.currentAttendance.date,
                class: this.currentAttendance.class,
                section: this.currentAttendance.section,
                students: this.currentAttendance.students
            };
            
            if (storage.saveAttendance(attendance)) {
                this.showToast({ type: 'success', message: 'Attendance saved successfully' });
                this.loadPage('attendance');
            } else {
                this.showToast({ type: 'error', message: 'Failed to save attendance' });
            }
        }
        
        viewAttendance(date, cls, section) {
            const attendance = storage.getAttendanceForClass(date, cls, section);
            if (!attendance) return;
            
            const presentCount = attendance.students?.filter(s => s.status === 'present').length || 0;
            const totalCount = attendance.students?.length || 0;
            const absentCount = totalCount - presentCount;
            
            const modalHtml = `
                <div class="modal-overlay" id="viewAttendanceModal">
                    <div class="modal" style="max-width: 800px;">
                        <div class="modal-header">
                            <h3 class="modal-title">Attendance Details</h3>
                            <button class="modal-close" id="closeViewAttendanceModal">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 2rem;">
                                <div>
                                    <h4>Class ${attendance.class} - Section ${attendance.section}</h4>
                                    <p>Date: ${new Date(attendance.date).toLocaleDateString()}</p>
                                </div>
                                <div style="text-align: right;">
                                    <div class="badge badge-success" style="font-size: 1.2rem; padding: 0.5rem 1rem;">
                                        Present: ${presentCount}
                                    </div>
                                    <div class="badge badge-danger" style="font-size: 1.2rem; padding: 0.5rem 1rem; margin-left: 0.5rem;">
                                        Absent: ${absentCount}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Roll No.</th>
                                            <th>Student Name</th>
                                            <th>Status</th>
                                            <th>Time</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${attendance.students?.map(student => `
                                            <tr>
                                                <td>${student.rollNo}</td>
                                                <td>${student.name}</td>
                                                <td>
                                                    <span class="badge ${student.status === 'present' ? 'badge-success' : 'badge-danger'}">
                                                        ${student.status === 'present' ? 'Present' : 'Absent'}
                                                    </span>
                                                </td>
                                                <td>${new Date(attendance.createdAt).toLocaleTimeString()}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="closeViewAttendanceBtn">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContainer').innerHTML = modalHtml;
            
            // Close buttons
            document.getElementById('closeViewAttendanceModal').addEventListener('click', () => {
                document.getElementById('viewAttendanceModal').remove();
            });
            
            document.getElementById('closeViewAttendanceBtn').addEventListener('click', () => {
                document.getElementById('viewAttendanceModal').remove();
            });
        }
        
        loadExams() {
            const exams = storage.getExams();
            const results = storage.getResults();
            
            const html = `
                <div class="page-header">
                    <h1 class="page-title">Exams & Results</h1>
                    <div class="page-actions">
                        <button class="btn btn-primary" id="addExamBtn">
                            <i class="fas fa-plus"></i> Add Exam
                        </button>
                        <button class="btn btn-success" id="addResultBtn">
                            <i class="fas fa-chart-bar"></i> Add Result
                        </button>
                    </div>
                </div>
                
                <div class="table-container" style="margin-bottom: 2rem;">
                    <div class="table-header">
                        <h3 class="table-title">Upcoming Exams (${exams.length})</h3>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Exam Name</th>
                                    <th>Class</th>
                                    <th>Subject</th>
                                    <th>Date</th>
                                    <th>Max Marks</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${exams.slice(0, 10).map(exam => `
                                    <tr>
                                        <td><strong>${exam.name}</strong></td>
                                        <td>Class ${exam.class}</td>
                                        <td>${exam.subject}</td>
                                        <td>${new Date(exam.date).toLocaleDateString()}</td>
                                        <td>${exam.maxMarks}</td>
                                        <td>
                                            <button class="btn btn-primary btn-sm enter-results-btn" data-id="${exam.id}">
                                                <i class="fas fa-edit"></i> Enter Results
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <h3 class="table-title">Recent Results</h3>
                        <div class="table-controls">
                            <select class="form-control" id="filterExamClass" style="width: 150px;">
                                <option value="">All Classes</option>
                                ${[...new Set(results.map(r => r.class))].sort((a, b) => a - b).map(cls => `
                                    <option value="${cls}">Class ${cls}</option>
                                `).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table id="resultsTable">
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Class</th>
                                    <th>Exam</th>
                                    <th>Subject</th>
                                    <th>Marks</th>
                                    <th>Percentage</th>
                                    <th>Grade</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${results.slice(0, 10).map(result => {
                                    const percentage = (result.marksObtained / result.maxMarks * 100).toFixed(1);
                                    let grade = 'F';
                                    let gradeClass = 'grade-f';
                                    
                                    if (percentage >= 90) { grade = 'A+'; gradeClass = 'grade-a'; }
                                    else if (percentage >= 80) { grade = 'A'; gradeClass = 'grade-a'; }
                                    else if (percentage >= 70) { grade = 'B'; gradeClass = 'grade-b'; }
                                    else if (percentage >= 60) { grade = 'C'; gradeClass = 'grade-c'; }
                                    else if (percentage >= 40) { grade = 'D'; gradeClass = 'grade-d'; }
                                    
                                    return `
                                        <tr>
                                            <td>${result.studentName}</td>
                                            <td>Class ${result.class}</td>
                                            <td>${result.examName}</td>
                                            <td>${result.subject}</td>
                                            <td>${result.marksObtained}/${result.maxMarks}</td>
                                            <td><strong>${percentage}%</strong></td>
                                            <td><span class="result-grade ${gradeClass}">${grade}</span></td>
                                            <td>
                                                <button class="btn btn-primary btn-sm edit-result-btn" data-id="${result.id}">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            document.getElementById('examsPage').innerHTML = html;
            
            // Event listeners
            document.getElementById('addExamBtn')?.addEventListener('click', () => this.showExamForm());
            document.getElementById('addResultBtn')?.addEventListener('click', () => this.showResultForm());
            
            // Enter results buttons
            document.querySelectorAll('.enter-results-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const examId = e.currentTarget.getAttribute('data-id');
                    this.showResultForm(null, examId);
                });
            });
            
            // Edit result buttons
            document.querySelectorAll('.edit-result-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const resultId = e.currentTarget.getAttribute('data-id');
                    this.showResultForm(resultId);
                });
            });
            
            // Filter results by class
            document.getElementById('filterExamClass')?.addEventListener('change', (e) => {
                const selectedClass = e.target.value;
                const rows = document.querySelectorAll('#resultsTable tbody tr');
                
                rows.forEach(row => {
                    const rowClass = row.cells[1].textContent.replace('Class ', '').trim();
                    if (!selectedClass || rowClass === selectedClass) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });
        }
        
        showExamForm(examId = null) {
            const exams = storage.getExams();
            let exam = null;
            
            if (examId) {
                exam = exams.find(e => e.id === examId);
            }
            
            const modalHtml = `
                <div class="modal-overlay" id="examModalOverlay">
                    <div class="modal">
                        <div class="modal-header">
                            <h3 class="modal-title">${exam ? 'Edit Exam' : 'Add New Exam'}</h3>
                            <button class="modal-close" id="closeExamModal">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form id="examForm">
                                <div class="form-group">
                                    <label class="form-label">Exam Name *</label>
                                    <input type="text" class="form-control" id="examName" 
                                           value="${exam?.name || ''}" required>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Class *</label>
                                        <select class="form-control" id="examClass" required>
                                            <option value="">Select Class</option>
                                            ${[...new Set(storage.getStudents().map(s => s.class))].sort((a, b) => a - b).map(cls => `
                                                <option value="${cls}" ${exam?.class === cls ? 'selected' : ''}>Class ${cls}</option>
                                            `).join('')}
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Subject *</label>
                                        <input type="text" class="form-control" id="examSubject" 
                                               value="${exam?.subject || ''}" required>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Exam Date *</label>
                                        <input type="date" class="form-control" id="examDate" 
                                               value="${exam?.date || ''}" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Maximum Marks *</label>
                                        <input type="number" class="form-control" id="maxMarks" 
                                               value="${exam?.maxMarks || 100}" required>
                                    </div>
                                </div>
                                
                                <input type="hidden" id="examId" value="${exam?.id || ''}">
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="cancelExamBtn">Cancel</button>
                            <button class="btn btn-primary" id="saveExamBtn">
                                ${exam ? 'Update Exam' : 'Save Exam'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContainer').innerHTML = modalHtml;
            
            // Event listeners
            document.getElementById('closeExamModal').addEventListener('click', () => {
                document.getElementById('examModalOverlay').remove();
            });
            
            document.getElementById('cancelExamBtn').addEventListener('click', () => {
                document.getElementById('examModalOverlay').remove();
            });
            
            document.getElementById('saveExamBtn').addEventListener('click', () => {
                this.saveExam();
            });
        }
        
        saveExam() {
            const exam = {
                id: document.getElementById('examId').value || null,
                name: document.getElementById('examName').value,
                class: document.getElementById('examClass').value,
                subject: document.getElementById('examSubject').value,
                date: document.getElementById('examDate').value,
                maxMarks: parseInt(document.getElementById('maxMarks').value) || 100
            };
            
            // Validation
            if (!exam.name || !exam.class || !exam.subject || !exam.date) {
                this.showToast({ type: 'error', message: 'Please fill all required fields' });
                return;
            }
            
            if (storage.saveExam(exam)) {
                this.showToast({ type: 'success', message: `Exam ${exam.id ? 'updated' : 'added'} successfully` });
                document.getElementById('examModalOverlay').remove();
                this.loadPage('exams');
            } else {
                this.showToast({ type: 'error', message: 'Failed to save exam' });
            }
        }
        
        showResultForm(resultId = null, examId = null) {
            const results = storage.getResults();
            const exams = storage.getExams();
            const students = storage.getStudents();
            let result = null;
            let exam = null;
            
            if (resultId) {
                result = results.find(r => r.id === resultId);
                exam = exams.find(e => e.id === result.examId);
            } else if (examId) {
                exam = exams.find(e => e.id === examId);
            }
            
            const modalHtml = `
                <div class="modal-overlay" id="resultModalOverlay">
                    <div class="modal" style="max-width: 600px;">
                        <div class="modal-header">
                            <h3 class="modal-title">${result ? 'Edit Result' : 'Enter Exam Result'}</h3>
                            <button class="modal-close" id="closeResultModal">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form id="resultForm">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Exam *</label>
                                        <select class="form-control" id="resultExam" required ${exam ? 'disabled' : ''}>
                                            <option value="">Select Exam</option>
                                            ${exams.map(e => `
                                                <option value="${e.id}" ${(result?.examId === e.id || exam?.id === e.id) ? 'selected' : ''}>
                                                    ${e.name} - Class ${e.class} - ${e.subject}
                                                </option>
                                            `).join('')}
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Student *</label>
                                        <select class="form-control" id="resultStudent" required>
                                            <option value="">Select Student</option>
                                            ${students.map(s => `
                                                <option value="${s.id}" ${result?.studentId === s.id ? 'selected' : ''}>
                                                    ${s.name} - Class ${s.class}${s.section ? ` - Sec ${s.section}` : ''} - Roll ${s.rollNo}
                                                </option>
                                            `).join('')}
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Marks Obtained *</label>
                                        <input type="number" class="form-control" id="marksObtained" 
                                               value="${result?.marksObtained || ''}" 
                                               max="${exam?.maxMarks || 100}" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Maximum Marks *</label>
                                        <input type="number" class="form-control" id="resultMaxMarks" 
                                               value="${result?.maxMarks || exam?.maxMarks || 100}" required>
                                    </div>
                                </div>
                                
                                <input type="hidden" id="resultId" value="${result?.id || ''}">
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="cancelResultBtn">Cancel</button>
                            <button class="btn btn-primary" id="saveResultBtn">
                                ${result ? 'Update Result' : 'Save Result'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContainer').innerHTML = modalHtml;
            
            // Event listeners
            document.getElementById('closeResultModal').addEventListener('click', () => {
                document.getElementById('resultModalOverlay').remove();
            });
            
            document.getElementById('cancelResultBtn').addEventListener('click', () => {
                document.getElementById('resultModalOverlay').remove();
            });
            
            document.getElementById('saveResultBtn').addEventListener('click', () => {
                this.saveResult();
            });
        }
        
        saveResult() {
            const examSelect = document.getElementById('resultExam');
            const examId = examSelect.value;
            const exam = storage.getExams().find(e => e.id === examId);
            
            const result = {
                id: document.getElementById('resultId').value || null,
                examId: examId,
                examName: exam?.name || '',
                studentId: document.getElementById('resultStudent').value,
                studentName: document.getElementById('resultStudent').selectedOptions[0]?.text.split(' - ')[0] || '',
                class: exam?.class || '',
                subject: exam?.subject || '',
                marksObtained: parseFloat(document.getElementById('marksObtained').value) || 0,
                maxMarks: parseFloat(document.getElementById('resultMaxMarks').value) || 100
            };
            
            // Validation
            if (!result.examId || !result.studentId || !result.marksObtained) {
                this.showToast({ type: 'error', message: 'Please fill all required fields' });
                return;
            }
            
            if (result.marksObtained > result.maxMarks) {
                this.showToast({ type: 'error', message: 'Marks obtained cannot exceed maximum marks' });
                return;
            }
            
            if (storage.saveResult(result)) {
                this.showToast({ type: 'success', message: `Result ${result.id ? 'updated' : 'saved'} successfully` });
                document.getElementById('resultModalOverlay').remove();
                this.loadPage('exams');
            } else {
                this.showToast({ type: 'error', message: 'Failed to save result' });
            }
        }
        
        loadFees() {
            const fees = storage.getFees();
            const feeStructure = storage.getFeeStructure();
            
            const html = `
                <div class="page-header">
                    <h1 class="page-title">Fee Management</h1>
                    <div class="page-actions">
                        <button class="btn btn-primary" id="addFeeBtn">
                            <i class="fas fa-plus"></i> Add Fee Record
                        </button>
                        <button class="btn btn-success" id="manageFeeStructureBtn">
                            <i class="fas fa-cogs"></i> Manage Fee Structure
                        </button>
                    </div>
                </div>
                
                <div class="table-container" style="margin-bottom: 2rem;">
                    <div class="table-header">
                        <h3 class="table-title">Fee Structure</h3>
                    </div>
                    <div class="table-responsive">
                        <table class="fee-structure-table">
                            <thead>
                                <tr>
                                    <th>Class</th>
                                    <th>Term</th>
                                    <th>Amount ()</th>
                                    <th>Description</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${feeStructure.map(fee => `
                                    <tr>
                                        <td>Class ${fee.class}</td>
                                        <td>${fee.term}</td>
                                        <td class="fee-amount">${parseInt(fee.amount).toLocaleString()}</td>
                                        <td>${fee.description || '-'}</td>
                                        <td>
                                            <button class="btn btn-primary btn-sm edit-fee-structure-btn" data-id="${fee.id}">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <h3 class="table-title">Fee Collection (${fees.length})</h3>
                        <div class="table-controls">
                            <select class="form-control" id="filterFeeStatus" style="width: 150px;">
                                <option value="">All Status</option>
                                <option value="paid">Paid</option>
                                <option value="pending">Pending</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table id="feesTable">
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Class</th>
                                    <th>Fee Type</th>
                                    <th>Amount ()</th>
                                    <th>Due Date</th>
                                    <th>Status</th>
                                    <th>Payment Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${fees.slice(0, 10).map(fee => {
                                    const student = storage.getStudents().find(s => s.id === fee.studentId);
                                    return `
                                        <tr>
                                            <td>${student?.name || fee.studentName}</td>
                                            <td>Class ${fee.class}</td>
                                            <td>${fee.feeType}</td>
                                            <td class="fee-amount">${parseInt(fee.amount).toLocaleString()}</td>
                                            <td>${new Date(fee.dueDate).toLocaleDateString()}</td>
                                            <td>
                                                <span class="badge ${fee.status === 'paid' ? 'badge-success' : 'badge-danger'}">
                                                    ${fee.status === 'paid' ? 'Paid' : 'Pending'}
                                                </span>
                                            </td>
                                            <td>${fee.paymentDate ? new Date(fee.paymentDate).toLocaleDateString() : '-'}</td>
                                            <td>
                                                <button class="btn btn-primary btn-sm edit-fee-btn" data-id="${fee.id}">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            document.getElementById('feesPage').innerHTML = html;
            
            // Event listeners
            document.getElementById('addFeeBtn')?.addEventListener('click', () => this.showFeeForm());
            document.getElementById('manageFeeStructureBtn')?.addEventListener('click', () => this.showFeeStructureForm());
            
            // Edit fee structure buttons
            document.querySelectorAll('.edit-fee-structure-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.currentTarget.getAttribute('data-id');
                    this.showFeeStructureForm(id);
                });
            });
            
            // Edit fee buttons
            document.querySelectorAll('.edit-fee-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.currentTarget.getAttribute('data-id');
                    this.showFeeForm(id);
                });
            });
            
            // Filter by status
            document.getElementById('filterFeeStatus')?.addEventListener('change', (e) => {
                const status = e.target.value;
                const rows = document.querySelectorAll('#feesTable tbody tr');
                
                rows.forEach(row => {
                    const rowStatus = row.cells[5].textContent.trim();
                    if (!status || rowStatus.toLowerCase() === status) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });
        }
        
        showFeeStructureForm(feeStructureId = null) {
            const feeStructure = storage.getFeeStructure();
            let feeStruct = null;
            
            if (feeStructureId) {
                feeStruct = feeStructure.find(f => f.id === feeStructureId);
            }
            
            const modalHtml = `
                <div class="modal-overlay" id="feeStructureModalOverlay">
                    <div class="modal">
                        <div class="modal-header">
                            <h3 class="modal-title">${feeStruct ? 'Edit Fee Structure' : 'Add Fee Structure'}</h3>
                            <button class="modal-close" id="closeFeeStructureModal">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form id="feeStructureForm">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Class *</label>
                                        <select class="form-control" id="feeClass" required>
                                            <option value="">Select Class</option>
                                            ${[...new Set(storage.getStudents().map(s => s.class))].sort((a, b) => a - b).map(cls => `
                                                <option value="${cls}" ${feeStruct?.class == cls ? 'selected' : ''}>Class ${cls}</option>
                                            `).join('')}
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Term *</label>
                                        <select class="form-control" id="feeTerm" required>
                                            <option value="">Select Term</option>
                                            <option value="Monthly" ${feeStruct?.term === 'Monthly' ? 'selected' : ''}>Monthly</option>
                                            <option value="Quarterly" ${feeStruct?.term === 'Quarterly' ? 'selected' : ''}>Quarterly</option>
                                            <option value="Half-Yearly" ${feeStruct?.term === 'Half-Yearly' ? 'selected' : ''}>Half-Yearly</option>
                                            <option value="Annual" ${feeStruct?.term === 'Annual' ? 'selected' : ''}>Annual</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Amount () *</label>
                                        <input type="number" class="form-control" id="feeAmount" 
                                               value="${feeStruct?.amount || ''}" required>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Description</label>
                                    <textarea class="form-control" id="feeDescription" rows="2">${feeStruct?.description || ''}</textarea>
                                </div>
                                
                                <input type="hidden" id="feeStructureId" value="${feeStruct?.id || ''}">
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="cancelFeeStructureBtn">Cancel</button>
                            <button class="btn btn-primary" id="saveFeeStructureBtn">
                                ${feeStruct ? 'Update Structure' : 'Save Structure'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContainer').innerHTML = modalHtml;
            
            // Event listeners
            document.getElementById('closeFeeStructureModal').addEventListener('click', () => {
                document.getElementById('feeStructureModalOverlay').remove();
            });
            
            document.getElementById('cancelFeeStructureBtn').addEventListener('click', () => {
                document.getElementById('feeStructureModalOverlay').remove();
            });
            
            document.getElementById('saveFeeStructureBtn').addEventListener('click', () => {
                this.saveFeeStructure();
            });
        }
        
        saveFeeStructure() {
            const feeStructure = {
                id: document.getElementById('feeStructureId').value || null,
                class: document.getElementById('feeClass').value,
                term: document.getElementById('feeTerm').value,
                amount: parseFloat(document.getElementById('feeAmount').value) || 0,
                description: document.getElementById('feeDescription').value
            };
            
            // Validation
            if (!feeStructure.class || !feeStructure.term || !feeStructure.amount) {
                this.showToast({ type: 'error', message: 'Please fill all required fields' });
                return;
            }
            
            if (storage.saveFeeStructure(feeStructure)) {
                this.showToast({ type: 'success', message: `Fee structure ${feeStructure.id ? 'updated' : 'added'} successfully` });
                document.getElementById('feeStructureModalOverlay').remove();
                this.loadPage('fees');
            } else {
                this.showToast({ type: 'error', message: 'Failed to save fee structure' });
            }
        }
        
        showFeeForm(feeId = null) {
            const fees = storage.getFees();
            const students = storage.getStudents();
            const feeStructure = storage.getFeeStructure();
            let fee = null;
            
            if (feeId) {
                fee = fees.find(f => f.id === feeId);
            }
            
            const modalHtml = `
                <div class="modal-overlay" id="feeModalOverlay">
                    <div class="modal">
                        <div class="modal-header">
                            <h3 class="modal-title">${fee ? 'Edit Fee Record' : 'Add Fee Record'}</h3>
                            <button class="modal-close" id="closeFeeModal">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form id="feeForm">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Student *</label>
                                        <select class="form-control" id="feeStudent" required>
                                            <option value="">Select Student</option>
                                            ${students.map(s => `
                                                <option value="${s.id}" ${fee?.studentId === s.id ? 'selected' : ''}>
                                                    ${s.name} - Class ${s.class}${s.section ? ` - Sec ${s.section}` : ''}
                                                </option>
                                            `).join('')}
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Fee Type *</label>
                                        <select class="form-control" id="feeType" required>
                                            <option value="">Select Fee Type</option>
                                            ${feeStructure.map(f => `
                                                <option value="${f.term} - Class ${f.class}" 
                                                        data-amount="${f.amount}"
                                                        ${fee?.feeType === `${f.term} - Class ${f.class}` ? 'selected' : ''}>
                                                    ${f.term} - Class ${f.class} (${f.amount})
                                                </option>
                                            `).join('')}
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Amount () *</label>
                                        <input type="number" class="form-control" id="feeRecordAmount" 
                                               value="${fee?.amount || ''}" required>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Due Date *</label>
                                        <input type="date" class="form-control" id="dueDate" 
                                               value="${fee?.dueDate || ''}" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Status *</label>
                                        <select class="form-control" id="feeStatus" required>
                                            <option value="pending" ${fee?.status === 'pending' ? 'selected' : ''}>Pending</option>
                                            <option value="paid" ${fee?.status === 'paid' ? 'selected' : ''}>Paid</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="form-group" id="paymentDateGroup" style="${fee?.status === 'paid' ? '' : 'display: none;'}">
                                    <label class="form-label">Payment Date</label>
                                    <input type="date" class="form-control" id="paymentDate" 
                                           value="${fee?.paymentDate || ''}">
                                </div>
                                
                                <input type="hidden" id="feeId" value="${fee?.id || ''}">
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="cancelFeeBtn">Cancel</button>
                            <button class="btn btn-primary" id="saveFeeBtn">
                                ${fee ? 'Update Fee' : 'Save Fee'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContainer').innerHTML = modalHtml;
            
            // Auto-fill amount when fee type is selected
            const feeTypeSelect = document.getElementById('feeType');
            const feeAmountInput = document.getElementById('feeRecordAmount');
            
            if (feeTypeSelect && feeAmountInput) {
                feeTypeSelect.addEventListener('change', (e) => {
                    const selectedOption = e.target.selectedOptions[0];
                    const amount = selectedOption.getAttribute('data-amount');
                    if (amount) {
                        feeAmountInput.value = amount;
                    }
                });
            }
            
            // Show/hide payment date based on status
            const feeStatusSelect = document.getElementById('feeStatus');
            const paymentDateGroup = document.getElementById('paymentDateGroup');
            
            if (feeStatusSelect && paymentDateGroup) {
                feeStatusSelect.addEventListener('change', (e) => {
                    if (e.target.value === 'paid') {
                        paymentDateGroup.style.display = 'block';
                    } else {
                        paymentDateGroup.style.display = 'none';
                    }
                });
            }
            
            // Event listeners
            document.getElementById('closeFeeModal').addEventListener('click', () => {
                document.getElementById('feeModalOverlay').remove();
            });
            
            document.getElementById('cancelFeeBtn').addEventListener('click', () => {
                document.getElementById('feeModalOverlay').remove();
            });
            
            document.getElementById('saveFeeBtn').addEventListener('click', () => {
                this.saveFee();
            });
        }
        
        saveFee() {
            const feeStudentSelect = document.getElementById('feeStudent');
            const student = storage.getStudents().find(s => s.id === feeStudentSelect.value);
            
            const fee = {
                id: document.getElementById('feeId').value || null,
                studentId: feeStudentSelect.value,
                studentName: student?.name || '',
                class: student?.class || '',
                feeType: document.getElementById('feeType').value,
                amount: parseFloat(document.getElementById('feeRecordAmount').value) || 0,
                dueDate: document.getElementById('dueDate').value,
                status: document.getElementById('feeStatus').value,
                paymentDate: document.getElementById('feeStatus').value === 'paid' ? 
                             (document.getElementById('paymentDate').value || new Date().toISOString().split('T')[0]) : null
            };
            
            // Validation
            if (!fee.studentId || !fee.feeType || !fee.amount || !fee.dueDate || !fee.status) {
                this.showToast({ type: 'error', message: 'Please fill all required fields' });
                return;
            }
            
            if (storage.saveFee(fee)) {
                this.showToast({ type: 'success', message: `Fee record ${fee.id ? 'updated' : 'added'} successfully` });
                document.getElementById('feeModalOverlay').remove();
                this.loadPage('fees');
            } else {
                this.showToast({ type: 'error', message: 'Failed to save fee record' });
            }
        }
        
        loadTimetable() {
            const timetable = storage.getTimetable();
            const classes = storage.getClasses();
            
            const html = `
                <div class="page-header">
                    <h1 class="page-title">Class Timetable</h1>
                    <div class="page-actions">
                        <button class="btn btn-primary" id="addTimetableBtn">
                            <i class="fas fa-plus"></i> Add Timetable
                        </button>
                    </div>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <h3 class="table-title">Timetable Management</h3>
                        <div class="table-controls">
                            <select class="form-control" id="timetableClass" style="width: 150px;">
                                <option value="">Select Class</option>
                                ${classes.map(cls => `
                                    <option value="${cls.name}">${cls.name}</option>
                                `).join('')}
                            </select>
                            <select class="form-control" id="timetableSection" style="width: 150px;">
                                <option value="">Select Section</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="timetableContent" style="padding: 1.5rem; text-align: center; color: var(--text-light);">
                        <i class="fas fa-calendar-alt fa-3x" style="margin-bottom: 1rem;"></i>
                        <p>Select class and section to view timetable</p>
                    </div>
                </div>
            `;
            
            document.getElementById('timetablePage').innerHTML = html;
            
            // Event listeners
            document.getElementById('addTimetableBtn')?.addEventListener('click', () => this.showTimetableForm());
            
            // Class selection
            document.getElementById('timetableClass')?.addEventListener('change', (e) => {
                const className = e.target.value;
                const sectionSelect = document.getElementById('timetableSection');
                
                if (className) {
                    const cls = classes.find(c => c.name === className);
                    const sections = Array.isArray(cls?.sections) ? cls.sections : [cls?.sections];
                    
                    sectionSelect.innerHTML = '<option value="">Select Section</option>' +
                        sections.map(sec => `<option value="${sec}">Section ${sec}</option>`).join('');
                } else {
                    sectionSelect.innerHTML = '<option value="">Select Section</option>';
                    document.getElementById('timetableContent').innerHTML = `
                        <i class="fas fa-calendar-alt fa-3x" style="margin-bottom: 1rem;"></i>
                        <p>Select class and section to view timetable</p>
                    `;
                }
            });
            
            // Section selection
            document.getElementById('timetableSection')?.addEventListener('change', (e) => {
                const className = document.getElementById('timetableClass').value;
                const section = e.target.value;
                
                if (className && section) {
                    this.displayTimetable(className, section);
                }
            });
        }
        
        displayTimetable(className, section) {
            const timetable = storage.getTimetable().find(t => 
                t.class === className && t.section === section
            );
            
            if (!timetable) {
                document.getElementById('timetableContent').innerHTML = `
                    <div style="padding: 2rem; text-align: center;">
                        <i class="fas fa-calendar-times fa-3x" style="margin-bottom: 1rem; color: var(--warning-color);"></i>
                        <h3>No timetable found for ${className} - Section ${section}</h3>
                        <p style="margin-bottom: 1.5rem;">Create a timetable for this class and section</p>
                        <button class="btn btn-primary" id="createTimetableBtn">
                            <i class="fas fa-plus"></i> Create Timetable
                        </button>
                    </div>
                `;
                
                document.getElementById('createTimetableBtn')?.addEventListener('click', () => {
                    this.showTimetableForm(null, className, section);
                });
                
                return;
            }
            
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const periods = ['Period 1', 'Period 2', 'Period 3', 'Period 4', 'Period 5', 'Period 6'];
            
            let timetableHtml = `
                <div style="margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                    <h3>Timetable for ${className} - Section ${section}</h3>
                    <button class="btn btn-primary btn-sm" id="editTimetableBtn" data-id="${timetable.id}">
                        <i class="fas fa-edit"></i> Edit Timetable
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="timetable">
                        <thead>
                            <tr>
                                <th>Day/Period</th>
                                ${periods.map(period => `<th>${period}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            days.forEach(day => {
                const daySchedule = timetable.periods?.find(p => p.day === day) || {};
                timetableHtml += `
                    <tr>
                        <td class="timetable-period"><strong>${day}</strong></td>
                        ${periods.map(period => {
                            const periodName = period.toLowerCase().replace(' ', '');
                            const subject = daySchedule[periodName];
                            
                            if (subject) {
                                const [subjectName, teacher] = subject.split(' - ');
                                return `
                                    <td>
                                        <div class="timetable-subject">${subjectName || ''}</div>
                                        <div class="timetable-teacher">${teacher || ''}</div>
                                    </td>
                                `;
                            } else {
                                return `<td>-</td>`;
                            }
                        }).join('')}
                    </tr>
                `;
            });
            
            timetableHtml += `
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('timetableContent').innerHTML = timetableHtml;
            
            // Edit timetable button
            document.getElementById('editTimetableBtn')?.addEventListener('click', (e) => {
                const timetableId = e.currentTarget.getAttribute('data-id');
                this.showTimetableForm(timetableId, className, section);
            });
        }
        
        showTimetableForm(timetableId = null, className = null, section = null) {
            const timetable = timetableId ? 
                storage.getTimetable().find(t => t.id === timetableId) : 
                { class: className, section: section, periods: [] };
            
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const periods = ['period1', 'period2', 'period3', 'period4', 'period5', 'period6'];
            
            let periodsHtml = '';
            
            days.forEach(day => {
                const daySchedule = timetable.periods?.find(p => p.day === day) || {};
                periodsHtml += `
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background-color: var(--bg-primary); border-radius: var(--border-radius);">
                        <h4 style="margin-bottom: 1rem;">${day}</h4>
                        <div class="form-row">
                `;
                
                periods.forEach(period => {
                    periodsHtml += `
                        <div class="form-group">
                            <label class="form-label">${period.replace('period', 'Period ')}</label>
                            <input type="text" class="form-control" 
                                   id="${day.toLowerCase()}_${period}" 
                                   value="${daySchedule[period] || ''}"
                                   placeholder="Subject - Teacher">
                        </div>
                    `;
                });
                
                periodsHtml += `
                        </div>
                    </div>
                `;
            });
            
            const modalHtml = `
                <div class="modal-overlay" id="timetableModalOverlay">
                    <div class="modal" style="max-width: 1200px;">
                        <div class="modal-header">
                            <h3 class="modal-title">${timetableId ? 'Edit Timetable' : 'Create Timetable'}</h3>
                            <button class="modal-close" id="closeTimetableModal">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
                            <form id="timetableForm">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Class *</label>
                                        <input type="text" class="form-control" id="timetableClassName" 
                                               value="${timetable.class || ''}" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Section *</label>
                                        <input type="text" class="form-control" id="timetableSectionName" 
                                               value="${timetable.section || ''}" required>
                                    </div>
                                </div>
                                
                                <h4 style="margin-top: 2rem; margin-bottom: 1rem;">Period Schedule</h4>
                                ${periodsHtml}
                                
                                <input type="hidden" id="timetableId" value="${timetableId || ''}">
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="cancelTimetableBtn">Cancel</button>
                            <button class="btn btn-primary" id="saveTimetableBtn">
                                ${timetableId ? 'Update Timetable' : 'Save Timetable'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContainer').innerHTML = modalHtml;
            
            // Event listeners
            document.getElementById('closeTimetableModal').addEventListener('click', () => {
                document.getElementById('timetableModalOverlay').remove();
            });
            
            document.getElementById('cancelTimetableBtn').addEventListener('click', () => {
                document.getElementById('timetableModalOverlay').remove();
            });
            
            document.getElementById('saveTimetableBtn').addEventListener('click', () => {
                this.saveTimetable();
            });
        }
        
        saveTimetable() {
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const periods = ['period1', 'period2', 'period3', 'period4', 'period5', 'period6'];
            
            const timetablePeriods = days.map(day => {
                const daySchedule = { day: day };
                periods.forEach(period => {
                    const inputId = `${day.toLowerCase()}_${period}`;
                    const input = document.getElementById(inputId);
                    daySchedule[period] = input?.value || '';
                });
                return daySchedule;
            });
            
            const timetable = {
                id: document.getElementById('timetableId').value || null,
                class: document.getElementById('timetableClassName').value,
                section: document.getElementById('timetableSectionName').value,
                periods: timetablePeriods
            };
            
            // Validation
            if (!timetable.class || !timetable.section) {
                this.showToast({ type: 'error', message: 'Please fill all required fields' });
                return;
            }
            
            if (storage.saveTimetable(timetable)) {
                this.showToast({ type: 'success', message: `Timetable ${timetable.id ? 'updated' : 'created'} successfully` });
                document.getElementById('timetableModalOverlay').remove();
                this.loadPage('timetable');
            } else {
                this.showToast({ type: 'error', message: 'Failed to save timetable' });
            }
        }
        
        loadNotices() {
            const notices = storage.getNotices();
            
            const html = `
                <div class="page-header">
                    <h1 class="page-title">Notice Board</h1>
                    <div class="page-actions">
                        <button class="btn btn-primary" id="addNewNoticeBtn">
                            <i class="fas fa-plus"></i> Add Notice
                        </button>
                    </div>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <h3 class="table-title">All Notices (${notices.length})</h3>
                        <div class="table-controls">
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" id="searchNotices" placeholder="Search notices...">
                            </div>
                        </div>
                    </div>
                    
                    <div class="notices-list">
                        ${notices.length > 0 ? notices.map(notice => `
                            <div class="notice-card ${notice.priority || ''}">
                                <div class="notice-header">
                                    <h4 class="notice-title">${notice.title}</h4>
                                    <div>
                                        <span class="notice-date">${new Date(notice.date).toLocaleDateString()}</span>
                                        ${notice.priority ? `<span class="badge ${notice.priority === 'important' ? 'badge-danger' : 'badge-warning'}" style="margin-left: 0.5rem;">
                                            ${notice.priority === 'important' ? 'Important' : 'Warning'}
                                        </span>` : ''}
                                    </div>
                                </div>
                                <div class="notice-content">
                                    ${notice.content}
                                </div>
                                <div style="margin-top: 1rem; display: flex; gap: 0.5rem; justify-content: flex-end;">
                                    <button class="btn btn-primary btn-sm edit-notice-btn" data-id="${notice.id}">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button class="btn btn-danger btn-sm delete-notice-btn" data-id="${notice.id}">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                        `).join('') : `
                            <div style="text-align: center; padding: 3rem; color: var(--text-light);">
                                <i class="fas fa-bullhorn fa-3x" style="margin-bottom: 1rem;"></i>
                                <h3>No notices yet</h3>
                                <p>Add your first notice to get started</p>
                            </div>
                        `}
                    </div>
                </div>
            `;
            
            document.getElementById('noticesPage').innerHTML = html;
            
            // Event listeners
            document.getElementById('addNewNoticeBtn')?.addEventListener('click', () => this.showNoticeForm());
            
            // Search functionality
            document.getElementById('searchNotices')?.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const noticeCards = document.querySelectorAll('.notice-card');
                
                noticeCards.forEach(card => {
                    const text = card.textContent.toLowerCase();
                    card.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            });
            
            // Edit notice buttons
            document.querySelectorAll('.edit-notice-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const noticeId = e.currentTarget.getAttribute('data-id');
                    this.showNoticeForm(noticeId);
                });
            });
            
            // Delete notice buttons
            document.querySelectorAll('.delete-notice-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const noticeId = e.currentTarget.getAttribute('data-id');
                    if (confirm('Are you sure you want to delete this notice?')) {
                        storage.deleteNotice(noticeId);
                        this.loadPage('notices');
                        this.showToast({ type: 'success', message: 'Notice deleted successfully' });
                    }
                });
            });
        }
        
        showNoticeForm(noticeId = null) {
            const notices = storage.getNotices();
            let notice = null;
            
            if (noticeId) {
                notice = notices.find(n => n.id === noticeId);
            }
            
            const modalHtml = `
                <div class="modal-overlay" id="noticeModalOverlay">
                    <div class="modal">
                        <div class="modal-header">
                            <h3 class="modal-title">${notice ? 'Edit Notice' : 'Add New Notice'}</h3>
                            <button class="modal-close" id="closeNoticeModal">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form id="noticeForm">
                                <div class="form-group">
                                    <label class="form-label">Title *</label>
                                    <input type="text" class="form-control" id="noticeTitle" 
                                           value="${notice?.title || ''}" required>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Priority</label>
                                        <select class="form-control" id="noticePriority">
                                            <option value="">Normal</option>
                                            <option value="important" ${notice?.priority === 'important' ? 'selected' : ''}>Important</option>
                                            <option value="warning" ${notice?.priority === 'warning' ? 'selected' : ''}>Warning</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Date</label>
                                        <input type="date" class="form-control" id="noticeDate" 
                                               value="${notice?.date ? notice.date.split('T')[0] : new Date().toISOString().split('T')[0]}">
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Content *</label>
                                    <textarea class="form-control" id="noticeContent" rows="5" required>${notice?.content || ''}</textarea>
                                </div>
                                
                                <input type="hidden" id="noticeId" value="${notice?.id || ''}">
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="cancelNoticeBtn">Cancel</button>
                            <button class="btn btn-primary" id="saveNoticeBtn">
                                ${notice ? 'Update Notice' : 'Publish Notice'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContainer').innerHTML = modalHtml;
            
            // Event listeners
            document.getElementById('closeNoticeModal').addEventListener('click', () => {
                document.getElementById('noticeModalOverlay').remove();
            });
            
            document.getElementById('cancelNoticeBtn').addEventListener('click', () => {
                document.getElementById('noticeModalOverlay').remove();
            });
            
            document.getElementById('saveNoticeBtn').addEventListener('click', () => {
                this.saveNotice();
            });
        }
        
        saveNotice() {
            const notice = {
                id: document.getElementById('noticeId').value || null,
                title: document.getElementById('noticeTitle').value,
                content: document.getElementById('noticeContent').value,
                priority: document.getElementById('noticePriority').value || null,
                date: document.getElementById('noticeDate').value
            };
            
            // Validation
            if (!notice.title || !notice.content) {
                this.showToast({ type: 'error', message: 'Please fill all required fields' });
                return;
            }
            
            if (storage.saveNotice(notice)) {
                this.showToast({ type: 'success', message: `Notice ${notice.id ? 'updated' : 'published'} successfully` });
                document.getElementById('noticeModalOverlay').remove();
                this.loadPage('notices');
            } else {
                this.showToast({ type: 'error', message: 'Failed to save notice' });
            }
        }
        
        loadSettings() {
            const settings = storage.get('settings');
            const students = storage.getStudents();
            const teachers = storage.getTeachers();
            const classes = storage.getClasses();
            
            const html = `
                <div class="page-header">
                    <h1 class="page-title">Settings</h1>
                </div>
                
                <div class="settings-container">
                    <div class="settings-nav">
                        <ul>
                            <li><a href="#school-settings" class="active" data-section="school">School Settings</a></li>
                            <li><a href="#security" data-section="security">Security</a></li>
                            <li><a href="#data-management" data-section="data">Data Management</a></li>
                            <li><a href="#system-info" data-section="system">System Information</a></li>
                        </ul>
                    </div>
                    
                    <div class="settings-content">
                        <div class="settings-section active" id="schoolSection">
                            <h3 style="margin-bottom: 1.5rem;">School Settings</h3>
                            <form id="schoolSettingsForm">
                                <div class="form-group">
                                    <label class="form-label">School Name</label>
                                    <input type="text" class="form-control" id="settingsSchoolName" 
                                           value="${settings.schoolName}">
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Academic Year</label>
                                        <input type="text" class="form-control" id="settingsAcademicYear" 
                                               value="${settings.academicYear}" placeholder="e.g., 2023-2024">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Theme</label>
                                        <select class="form-control" id="settingsTheme">
                                            <option value="light" ${settings.theme === 'light' ? 'selected' : ''}>Light</option>
                                            <option value="dark" ${settings.theme === 'dark' ? 'selected' : ''}>Dark</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" id="autoLock" ${settings.autoLock ? 'checked' : ''}>
                                        <label for="autoLock">Auto-lock system after 15 minutes of inactivity</label>
                                    </div>
                                </div>
                                
                                <button type="button" class="btn btn-primary" id="saveSchoolSettings">
                                    Save Settings
                                </button>
                            </form>
                        </div>
                        
                        <div class="settings-section" id="securitySection">
                            <h3 style="margin-bottom: 1.5rem;">Security Settings</h3>
                            <form id="securitySettingsForm">
                                <div class="form-group">
                                    <label class="form-label">Change PIN</label>
                                    <input type="password" class="form-control" id="newPin" 
                                           placeholder="Enter new 4-digit PIN" maxlength="4">
                                    <small class="text-muted">PIN must be 4 digits</small>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Confirm PIN</label>
                                    <input type="password" class="form-control" id="confirmPin" 
                                           placeholder="Confirm new PIN" maxlength="4">
                                </div>
                                
                                <button type="button" class="btn btn-primary" id="changePinBtn">
                                    Change PIN
                                </button>
                            </form>
                        </div>
                        
                        <div class="settings-section" id="dataSection">
                            <h3 style="margin-bottom: 1.5rem;">Data Management</h3>
                            <div style="display: flex; flex-direction: column; gap: 1rem;">
                                <div class="card" style="margin-bottom: 0;">
                                    <div class="card-header">
                                        <h4 class="card-title">Export Data</h4>
                                    </div>
                                    <div class="card-value" style="font-size: 1rem; margin-bottom: 1rem;">
                                        Export all school data to a backup file
                                    </div>
                                    <button class="btn btn-success" id="exportDataBtn">
                                        <i class="fas fa-download"></i> Export All Data
                                    </button>
                                </div>
                                
                                <div class="card" style="margin-bottom: 0;">
                                    <div class="card-header">
                                        <h4 class="card-title">Import Data</h4>
                                    </div>
                                    <div class="card-value" style="font-size: 1rem; margin-bottom: 1rem;">
                                        Import data from a backup file (This will replace current data)
                                    </div>
                                    <input type="file" id="importFile" accept=".json" style="margin-bottom: 1rem;">
                                    <button class="btn btn-warning" id="importDataBtn" disabled>
                                        <i class="fas fa-upload"></i> Import Data
                                    </button>
                                </div>
                                
                                <div class="card" style="margin-bottom: 0; border-color: var(--danger-color);">
                                    <div class="card-header">
                                        <h4 class="card-title" style="color: var(--danger-color);">Danger Zone</h4>
                                    </div>
                                    <div class="card-value" style="font-size: 1rem; margin-bottom: 1rem;">
                                        Clear all data from the system. This action cannot be undone.
                                    </div>
                                    <button class="btn btn-danger" id="clearDataBtn">
                                        <i class="fas fa-trash"></i> Clear All Data
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="settings-section" id="systemSection">
                            <h3 style="margin-bottom: 1.5rem;">System Information</h3>
                            <div class="card" style="margin-bottom: 1.5rem;">
                                <div class="card-header">
                                    <h4 class="card-title">Data Statistics</h4>
                                </div>
                                <div style="padding: 1rem;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                        <span>Students:</span>
                                        <strong>${students.length}</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                        <span>Teachers:</span>
                                        <strong>${teachers.length}</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                        <span>Classes:</span>
                                        <strong>${classes.length}</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>Storage Used:</span>
                                        <strong id="storageInfo">Calculating...</strong>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h4 class="card-title">System Status</h4>
                                </div>
                                <div style="padding: 1rem;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                        <span>Application Version:</span>
                                        <strong>1.0.0</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                        <span>Offline Mode:</span>
                                        <span class="badge badge-success">Active</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>Last Backup:</span>
                                        <strong>${new Date().toLocaleDateString()}</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('settingsPage').innerHTML = html;
            
            // Update storage info
            setTimeout(() => {
                storage.updateStorageUsage();
                const usedKB = document.getElementById('storageUsed')?.textContent || '0';
                document.getElementById('storageInfo').textContent = `${usedKB} KB`;
            }, 100);
            
            // Settings navigation
            document.querySelectorAll('.settings-nav a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const section = link.getAttribute('data-section');
                    
                    document.querySelectorAll('.settings-nav a').forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    
                    document.querySelectorAll('.settings-section').forEach(sec => {
                        sec.classList.remove('active');
                    });
                    
                    document.getElementById(`${section}Section`).classList.add('active');
                });
            });
            
            // Save school settings
            document.getElementById('saveSchoolSettings')?.addEventListener('click', () => {
                const updatedSettings = {
                    ...settings,
                    schoolName: document.getElementById('settingsSchoolName').value,
                    academicYear: document.getElementById('settingsAcademicYear').value,
                    theme: document.getElementById('settingsTheme').value,
                    autoLock: document.getElementById('autoLock').checked
                };
                
                storage.set('settings', updatedSettings);
                this.applyTheme();
                
                document.getElementById('schoolName').textContent = updatedSettings.schoolName;
                document.getElementById('academicYear').textContent = `Academic Year: ${updatedSettings.academicYear}`;
                
                this.showToast({ type: 'success', message: 'Settings saved successfully' });
            });
            
            // Change PIN
            document.getElementById('changePinBtn')?.addEventListener('click', () => {
                const newPin = document.getElementById('newPin').value;
                const confirmPin = document.getElementById('confirmPin').value;
                
                if (!newPin || !confirmPin) {
                    this.showToast({ type: 'error', message: 'Please enter and confirm PIN' });
                    return;
                }
                
                if (newPin.length !== 4 || !/^\d+$/.test(newPin)) {
                    this.showToast({ type: 'error', message: 'PIN must be 4 digits' });
                    return;
                }
                
                if (newPin !== confirmPin) {
                    this.showToast({ type: 'error', message: 'PINs do not match' });
                    return;
                }
                
                const updatedSettings = { ...settings, pin: newPin };
                storage.set('settings', updatedSettings);
                
                document.getElementById('newPin').value = '';
                document.getElementById('confirmPin').value = '';
                
                this.showToast({ type: 'success', message: 'PIN changed successfully' });
            });
            
            // Export data
            document.getElementById('exportDataBtn')?.addEventListener('click', () => {
                storage.exportData();
                this.showToast({ type: 'success', message: 'Data exported successfully' });
            });
            
            // Import data
            const importFileInput = document.getElementById('importFile');
            const importDataBtn = document.getElementById('importDataBtn');
            
            importFileInput?.addEventListener('change', (e) => {
                importDataBtn.disabled = !e.target.files.length;
            });
            
            importDataBtn?.addEventListener('click', async () => {
                const file = importFileInput.files[0];
                if (!file) return;
                
                if (!confirm('This will replace all existing data. Are you sure?')) {
                    return;
                }
                
                try {
                    await storage.importData(file);
                    this.showToast({ type: 'success', message: 'Data imported successfully' });
                    this.loadPage('settings');
                    location.reload();
                } catch (error) {
                    this.showToast({ type: 'error', message: 'Failed to import data: ' + error.message });
                }
            });
            
            // Clear data
            document.getElementById('clearDataBtn')?.addEventListener('click', () => {
                if (confirm('This will delete ALL data permanently. Are you absolutely sure?')) {
                    localStorage.clear();
                    location.reload();
                }
            });
        }
        
        showExportModal() {
            const modalHtml = `
                <div class="modal-overlay" id="exportModalOverlay">
                    <div class="modal">
                        <div class="modal-header">
                            <h3 class="modal-title">Export Data</h3>
                            <button class="modal-close" id="closeExportModal">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <p>Export all school data to a backup file. This file can be used to restore your data later.</p>
                            <div class="card" style="margin-top: 1rem;">
                                <div class="card-value" style="font-size: 1rem;">
                                    <i class="fas fa-info-circle"></i> The backup will include:
                                </div>
                                <ul style="margin-top: 0.5rem; padding-left: 1.5rem;">
                                    <li>All student records</li>
                                    <li>All teacher records</li>
                                    <li>Attendance data</li>
                                    <li>Exam results</li>
                                    <li>Fee records</li>
                                    <li>Notices and settings</li>
                                </ul>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="cancelExportBtn">Cancel</button>
                            <button class="btn btn-primary" id="confirmExportBtn">
                                <i class="fas fa-download"></i> Export Now
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContainer').innerHTML = modalHtml;
            
            // Event listeners
            document.getElementById('closeExportModal').addEventListener('click', () => {
                document.getElementById('exportModalOverlay').remove();
            });
            
            document.getElementById('cancelExportBtn').addEventListener('click', () => {
                document.getElementById('exportModalOverlay').remove();
            });
            
            document.getElementById('confirmExportBtn').addEventListener('click', () => {
                storage.exportData();
                this.showToast({ type: 'success', message: 'Data exported successfully' });
                document.getElementById('exportModalOverlay').remove();
            });
        }
        
        showImportModal() {
            const modalHtml = `
                <div class="modal-overlay" id="importModalOverlay">
                    <div class="modal">
                        <div class="modal-header">
                            <h3 class="modal-title">Import Data</h3>
                            <button class="modal-close" id="closeImportModal">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <p>Import data from a backup file. This will replace all existing data.</p>
                            <div class="form-group">
                                <label class="form-label">Select backup file</label>
                                <input type="file" class="form-control" id="backupFile" accept=".json">
                            </div>
                            <div class="card" style="margin-top: 1rem; border-color: var(--warning-color);">
                                <div class="card-value" style="font-size: 1rem; color: var(--warning-color);">
                                    <i class="fas fa-exclamation-triangle"></i> Warning
                                </div>
                                <p style="margin-top: 0.5rem;">
                                    Importing data will replace ALL existing data. Make sure you have a current backup.
                                </p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="cancelImportBtn">Cancel</button>
                            <button class="btn btn-primary" id="confirmImportBtn" disabled>
                                <i class="fas fa-upload"></i> Import Data
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modalContainer').innerHTML = modalHtml;
            
            const backupFileInput = document.getElementById('backupFile');
            const confirmImportBtn = document.getElementById('confirmImportBtn');
            
            backupFileInput.addEventListener('change', (e) => {
                confirmImportBtn.disabled = !e.target.files.length;
            });
            
            // Event listeners
            document.getElementById('closeImportModal').addEventListener('click', () => {
                document.getElementById('importModalOverlay').remove();
            });
            
            document.getElementById('cancelImportBtn').addEventListener('click', () => {
                document.getElementById('importModalOverlay').remove();
            });
            
            confirmImportBtn.addEventListener('click', async () => {
                const file = backupFileInput.files[0];
                if (!file) return;
                
                try {
                    await storage.importData(file);
                    this.showToast({ type: 'success', message: 'Data imported successfully' });
                    document.getElementById('importModalOverlay').remove();
                    location.reload();
                } catch (error) {
                    this.showToast({ type: 'error', message: 'Failed to import data: ' + error.message });
                }
            });
        }
        
        showToast(options) {
            const { type = 'info', message = '', duration = 3000 } = options;
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="toast-icon">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : 
                                  type === 'error' ? 'fa-exclamation-circle' : 
                                  type === 'warning' ? 'fa-exclamation-triangle' : 
                                  'fa-info-circle'}"></i>
                </div>
                <div class="toast-message">${message}</div>
                <button class="toast-close">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            document.getElementById('toastContainer').appendChild(toast);
            
            // Remove toast after duration
            const timer = setTimeout(() => {
                toast.remove();
            }, duration);
            
            // Close button
            toast.querySelector('.toast-close').addEventListener('click', () => {
                clearTimeout(timer);
                toast.remove();
            });
            
            // Auto-remove animation
            toast.style.animation = 'slideInRight 0.3s ease';
        }
    }

    // Initialize the application
    document.addEventListener('DOMContentLoaded', () => {
        // Check if already unlocked
        const settings = window.storage ? window.storage.get('settings') : null;
        if (settings && !settings.autoLock) {
            document.getElementById('lockScreen').style.display = 'none';
            document.getElementById('appContainer').style.display = 'flex';
            window.ui = new SchoolERPUI();
        } else {
            // Focus on PIN input
            document.getElementById('pinField').focus();
            
            // Initialize storage first
            window.storage = new SchoolERPStorage();
            window.ui = new SchoolERPUI();
        }
        
        // Make showToast globally available
        window.showToast = (options) => {
            if (window.ui) {
                window.ui.showToast(options);
            }
        };
    });
</script>
</body> </html>
